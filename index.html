<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Детская Студия</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* (копируй стили из твоего оригинала — сокращаю здесь для компактности) */
    :root{--bg-main:#101010;--bg-secondary:#1C1C1C;--text-main:#fff;--text-secondary:#8E8E93;--accent-blue:#007AFF;--border:#2D2D2D}
    body{background:var(--bg-main);color:var(--text-main);font-family:Inter,system-ui,Arial;padding:16px;margin:0}
    .container{max-width:800px;margin:0 auto}
    .loader{text-align:center;padding:40px}
    /* остальной CSS можно оставить как у тебя */
  </style>
</head>
<body>
  <div class="container">
    <div id="app">
      <div id="loader" class="loader">Загрузка...</div>
      <div id="main-content" style="display:none">
        <!-- вставь сюда твой HTML интерфейс (календарь/тренеры/профиль) -->
        <h1>Детская Студия</h1>
        <div id="week-display"></div>
        <div id="days-grid"></div>
        <div id="slots-list"></div>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', async ()=> {
  const tg = window.Telegram.WebApp;
  tg.expand();

  // DEBUG: покажем initData
  console.log('tg.initData:', tg.initData);
  console.log('tg.initDataUnsafe:', tg.initDataUnsafe);

  // --- CONFIG: поставь сюда URL деплоя GAS
  const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwdVdDFU-_w7VK_t-u0tTNbnm4YwhTspaBKUuq6JwUOlAqKiFLFPcQ_W1My1pTNKRl-7A/exec';

  // --- state ---
  const state = { allSlots: [], trainers: {}, user: null, children: [], balances: {}, selectedDate: null, currentWeekStart: null };

  // --- helpers ---
  function toYMD(d){ const D=new Date(d); return `${D.getFullYear()}-${String(D.getMonth()+1).padStart(2,'0')}-${String(D.getDate()).padStart(2,'0')}`; }
  function formatDay(d){ return new Date(d).toLocaleDateString('ru-RU', {weekday:'short'}).toUpperCase(); }
  function formatFull(d){ return new Date(d).toLocaleDateString('ru-RU', {weekday:'long', day:'numeric', month:'long'}); }

  async function apiCall(action, payload={}) {
    // if tg.initData exists, send it; otherwise send initDataUnsafe as JSON string (dev fallback)
    const initData = tg.initData || '';
    const body = Object.assign({}, {action}, payload);
    if (initData) body.initData = initData;
    else body.initDataUnsafe = JSON.stringify(tg.initDataUnsafe || {}); // dev fallback

    try {
      const res = await fetch(API_BASE_URL, { method:'POST', headers:{ 'Content-Type':'text/plain;charset=utf-8' }, body: JSON.stringify(body) });
      const data = await res.json();
      // server uses semantic responses: arrays or {success:false}
      if (data && data.success === false) throw new Error(data.message || 'Server error');
      return data;
    } catch (err) {
      console.error('apiCall error', err);
      tg.showAlert(err.message || 'Ошибка связи');
      throw err;
    }
  }

  // --- render ---
  const loaderEl = document.getElementById('loader');
  const mainEl = document.getElementById('main-content');
  const daysGrid = document.getElementById('days-grid');
  const slotsList = document.getElementById('slots-list');
  const weekDisplay = document.getElementById('week-display');

  function getStartOfWeek(date) {
    const d = new Date(date); d.setHours(0,0,0,0);
    const day = d.getDay();
    const diff = d.getDate() - day + (day===0 ? -6 : 1);
    return new Date(d.setDate(diff));
  }

  function renderCalendar() {
    const weekStart = state.currentWeekStart;
    const weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate()+6);
    weekDisplay.textContent = `${weekStart.toLocaleDateString('ru-RU',{day:'numeric',month:'long'})} — ${weekEnd.toLocaleDateString('ru-RU',{day:'numeric',month:'long'})}`;
    daysGrid.innerHTML = '';
    for (let i=0;i<7;i++){
      const d = new Date(weekStart); d.setDate(weekStart.getDate()+i);
      const key = toYMD(d);
      const el = document.createElement('button');
      el.textContent = `${formatDay(d)} ${d.getDate()}`;
      el.style.margin='4px';
      const has = state.allSlots.some(s => String(s.date)===key);
      if (has) { el.style.opacity=1; el.onclick = ()=> { state.selectedDate = key; renderSlots(); }; }
      else el.style.opacity=0.4;
      if (state.selectedDate===key) el.style.background='#007AFF';
      daysGrid.appendChild(el);
    }
    renderSlots();
  }

  function renderSlots(){
    const date = state.selectedDate;
    if (!date) { slotsList.innerHTML = '<i>Выберите день</i>'; return; }
    const slots = state.allSlots.filter(s => String(s.date) === date);
    if (!slots.length) { slotsList.innerHTML = '<i>На этот день слотов нет</i>'; return; }
    slotsList.innerHTML = '';
    slots.forEach(s=>{
      const left = document.createElement('div'); left.textContent = `${s.time} — тренер: ${ (state.trainers[s.trainer_id] && state.trainers[s.trainer_id].name) || s.trainer_id }`;
      const btn = document.createElement('button'); btn.textContent = `Записаться (${ (Number(s.capacity||0) - Number(s.booked||0)) })`;
      btn.disabled = (Number(s.capacity||0) - Number(s.booked||0)) <= 0;
      btn.onclick = async ()=> {
        if (!state.children || state.children.length===0) { tg.showAlert('Сначала добавьте ребёнка во вкладке профиль'); return; }
        const childId = state.children[0].child_id;
        try {
          await apiCall('book', { slot_id: s.slot_id, child_id });
          tg.showPopup({ title:'Готово', message:'Записано' });
          // обновим локально
          s.booked = Number(s.booked||0) + 1;
          renderSlots();
        } catch(e) { console.error(e); }
      };
      const wrap = document.createElement('div');
      wrap.style.border='1px solid #333'; wrap.style.padding='8px'; wrap.style.margin='8px 0'; wrap.appendChild(left); wrap.appendChild(btn);
      slotsList.appendChild(wrap);
    });
  }

  // --- initial load ---
  try {
    const bs = await apiCall('bootstrap');
    state.user = bs.parent || null;
    state.children = bs.children || [];
    state.balances = (bs.balances || []).reduce((a,b)=>{a[b.child_id]=b;return a;},{});
    state.trainers = (bs.trainers || []).reduce((a,t)=>{a[t.trainer_id]=t;return a;},{});
    // calendar setup
    state.currentWeekStart = getStartOfWeek(new Date());
    // default select today if exists
    state.selectedDate = toYMD(new Date());
    // fetch slots for the week
    const from = toYMD(state.currentWeekStart);
    const to = toYMD(new Date(state.currentWeekStart.getFullYear(), state.currentWeekStart.getMonth(), state.currentWeekStart.getDate()+6));
    const slots = await apiCall('slots', { from, to });
    state.allSlots = Array.isArray(slots) ? slots : [];
    // auto select first slot day if today's empty
    const todayHas = state.allSlots.some(s => String(s.date) === toYMD(new Date()));
    if (!todayHas && state.allSlots.length>0) {
      state.selectedDate = state.allSlots.map(s=>String(s.date)).sort()[0];
    }
    loaderEl.style.display='none';
    mainEl.style.display='block';
    renderCalendar();
  } catch (err) {
    loaderEl.textContent = 'Ошибка загрузки: ' + (err && err.message ? err.message : '');
    console.error(err);
  }
});
</script>
</body>
</html>
