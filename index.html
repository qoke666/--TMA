<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Детская Студия</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-main: #101010;--bg-secondary: #1C1C1C;--text-main: #FFFFFF;--text-secondary: #8E8E93;--accent-blue: #007AFF;--accent-green: #34C759;--accent-red: #FF3B30;--border-color: #2D2D2D;
    }
    @font-face { font-family: 'Inter'; src: url('https://rsms.me/inter/font-files/Inter-Regular.woff2?v=3.19') format('woff2'); font-weight: 400; }
    @font-face { font-family: 'Inter'; src: url('https://rsms.me/inter/font-files/Inter-Medium.woff2?v=3.19') format('woff2'); font-weight: 500; }
    @font-face { font-family: 'Inter'; src: url('https://rsms.me/inter/font-files/Inter-SemiBold.woff2?v=3.19') format('woff2'); font-weight: 600; }
    @font-face { font-family: 'Inter'; src: url('https://rsms.me/inter/font-files/Inter-Bold.woff2?v=3.19') format('woff2'); font-weight: 700; }
    body { font-family: 'Inter', -apple-system, sans-serif; margin: 0; background-color: var(--bg-main); color: var(--text-main); padding: 16px; -webkit-font-smoothing: antialiased; }
    .container { max-width: 800px; margin: 0 auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .header__logo svg { width: 40px; height: 40px; }
    .header__user { display: flex; align-items: center; gap: 10px; }
    .header__user-avatar { width: 36px; height: 36px; border-radius: 50%; background-color: var(--bg-secondary); border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; }
    .header__user-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
    .header__user-name { font-weight: 500; }
    .promo { background-color: var(--bg-secondary); border-radius: 16px; padding: 24px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; gap: 20px; }
    .promo__text { flex: 1; }
    .promo__title { font-size: 24px; font-weight: 700; margin: 0 0 8px 0; }
    .promo__subtitle { font-size: 16px; color: var(--text-secondary); margin: 0; }
    .promo__image img { width: 100px; height: 100px; }
    .tabs { display: flex; gap: 8px; margin-bottom: 24px; overflow-x: auto; scrollbar-width: none; }
    .tabs::-webkit-scrollbar { display: none; }
    .tab { padding: 10px 16px; border: 1px solid var(--border-color); border-radius: 20px; cursor: pointer; font-weight: 500; white-space: nowrap; transition: background-color 0.2s, color 0.2s; }
    .tab.active { background-color: var(--accent-blue); color: var(--text-main); border-color: var(--accent-blue); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .section-title { font-size: 20px; font-weight: 600; margin-bottom: 16px; }
    .calendar-container { background-color: var(--bg-secondary); border-radius: 16px; padding: 20px; }
    .week-selector { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .week-selector__arrow { cursor: pointer; padding: 8px; }
    .week-selector__arrow svg { width: 24px; height: 24px; stroke: var(--text-secondary); }
    .week-selector__date { font-size: 18px; font-weight: 600; text-align: center;}
    .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-bottom: 20px; text-align: center; }
    .day { padding: 10px 5px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; opacity: 0.5; }
    .day.selectable { opacity: 1; }
    .day.active { background-color: var(--accent-blue); }
    .day.has-slots::after { content: ''; display: block; width: 4px; height: 4px; background-color: var(--accent-blue); border-radius: 50%; margin: 4px auto 0; }
    .day__name { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
    .day__date { font-weight: 600; }
    .slots-list .slot-card { background-color: var(--bg-main); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
    .slot-card__info { display: flex; flex-direction: column; gap: 4px; }
    .slot-card__time { font-size: 18px; font-weight: 600; }
    .slot-card__details { font-size: 14px; color: var(--text-secondary); }
    .slot-card__action .btn { background-color: var(--accent-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: opacity 0.2s, background-color 0.2s; }
    .slot-card__action .btn:disabled { background-color: #555; opacity: 0.6; cursor: not-allowed; }
    .trainers-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px; }
    .trainer-card { background-color: var(--bg-secondary); border-radius: 16px; padding: 20px; text-align: center; }
    .trainer-card__avatar img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 12px; border: 2px solid var(--border-color); }
    .trainer-card__name { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
    .trainer-card__speciality { color: var(--text-secondary); margin-bottom: 16px; }
    .trainer-card__contact-btn { display: inline-block; background-color: var(--bg-main); color: var(--text-main); border: 1px solid var(--border-color); padding: 10px 20px; border-radius: 8px; font-weight: 500; text-decoration: none; }
    .profile-section { background-color: var(--bg-secondary); border-radius: 16px; padding: 20px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
    .form-group input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-main); color: var(--text-main); font-size: 16px; box-sizing: border-box; }
    .submit-btn { width: 100%; padding: 14px; border: none; border-radius: 8px; background-color: var(--accent-blue); color: var(--text-main); font-size: 16px; font-weight: 600; cursor: pointer; }
    .child-switcher { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .child-tab { padding: 8px 14px; border: 1px solid var(--border-color); border-radius: 20px; cursor: pointer; }
    .child-tab.active { background-color: var(--accent-green); border-color: var(--accent-green); }
    .balance-info { font-size: 18px; font-weight: 500; }
    .loader { text-align: center; padding: 40px; }
  </style>
</head>

<body>
  <div class="container">
    <header class="header">
      <div class="header__logo">
        <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="20" cy="20" r="20" fill="white"/><path d="M20 31.6667C26.4435 31.6667 31.6667 26.4435 31.6667 20C31.6667 13.5565 26.4435 8.33334 20 8.33334C13.5565 8.33334 8.33337 13.5565 8.33337 20C8.33337 26.4435 13.5565 31.6667 20 31.6667Z" fill="#007AFF"/></svg>
      </div>
      <div class="header__user">
        <div class="header__user-avatar"><img id="user-avatar" src="" alt=""></div>
        <div class="header__user-name" id="user-name"></div>
      </div>
    </header>

    <main id="main-content" style="display: none;">
      <section class="promo">
        <div class="promo__text">
          <h1 class="promo__title">Запись на занятия</h1>
          <p class="promo__subtitle">Выберите удобное время для вашего ребенка и запишитесь в один клик.</p>
        </div>
        <div class="promo__image">
          <img src="https://em-content.zobj.net/source/apple/354/person-cartwheeling_1f938.png" alt="Гимнастика">
        </div>
      </section>

      <nav class="tabs">
        <div class="tab active" data-tab="schedule">Расписание</div>
        <div class="tab" data-tab="trainers">Тренеры</div>
        <div class="tab" data-tab="profile">Мой профиль</div>
      </nav>

      <div class="tab-content active" id="schedule">
        <div class="calendar-container">
            <div class="week-selector">
                <div class="week-selector__arrow" id="prev-week"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg></div>
                <div class="week-selector__date" id="week-display"></div>
                <div class="week-selector__arrow" id="next-week"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" /></svg></div>
            </div>
            <div class="days-grid" id="days-grid-container"></div>
            <div class="slots-list" id="slots-list-container"></div>
        </div>
      </div>

      <div class="tab-content" id="trainers"><div class="section-title">Наши тренеры</div><div class="trainers-grid" id="trainers-grid-container"></div></div>

      <div class="tab-content" id="profile"><div class="section-title">Мой профиль</div><div class="profile-section" id="profile-section-container"></div></div>
    </main>
     <div class="loader" id="loader">Загрузка...</div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const tg = window.Telegram.WebApp;
      tg.expand();

      // --- CONFIG ---
      const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwdVdDFU-_w7VK_t-u0tTNbnm4YwhTspaBKUuq6JwUOlAqKiFLFPcQ_W1My1pTNKRl-7A/exec'; // ⚠️ PASTE YOUR DEPLOYED URL HERE
      const tgInitData = tg.initData || '';

      // --- STATE ---
      const appState = {
        user: null, children: [], balances: {}, trainers: {},
        allSlots: [], selectedChildId: null,
        currentWeekStart: null, selectedDate: null,
      };

      // --- DOM ELEMENTS ---
      const el = {
          loader: document.getElementById('loader'),
          mainContent: document.getElementById('main-content'),
          userName: document.getElementById('user-name'),
          weekDisplay: document.getElementById('week-display'),
          daysGrid: document.getElementById('days-grid-container'),
          slotsList: document.getElementById('slots-list-container'),
          trainersGrid: document.getElementById('trainers-grid-container'),
          profileSection: document.getElementById('profile-section-container'),
          prevWeekBtn: document.getElementById('prev-week'),
          nextWeekBtn: document.getElementById('next-week'),
      };

      // --- API HELPER ---
      async function apiCall(action, payload = {}) {
        const body = { action, initData: tgInitData, ...payload };
        try {
          const response = await fetch(API_BASE_URL, {
            method: 'POST',
            // Using text/plain is a common workaround for Google Apps Script's CORS behavior.
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
            body: JSON.stringify(body),
          });
          if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`HTTP error ${response.status}: ${errorText}`);
          }
          return await response.json();
        } catch (error) {
          console.error(`API Error (${action}):`, error);
          tg.showAlert(`Ошибка сети или сервера. Попробуйте позже.`);
          throw error;
        }
      }

      // --- DATE HELPERS ---
      function getStartOfWeek(date) {
        const d = new Date(date);
        d.setHours(0,0,0,0);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
        return new Date(d.setDate(diff));
      }
      function formatDate(date, options) {
          return date.toLocaleDateString('ru-RU', options);
      }
      function toYYYYMMDD(date) {
        return date.toISOString().split('T')[0];
      }

      // --- RENDER FUNCTIONS ---
      function renderUserInfo() {
        const tgUser = tg.initDataUnsafe?.user;
        el.userName.textContent = appState.user ? appState.user.full_name : (tgUser?.first_name || 'Гость');
      }

      function renderCalendar() {
        const weekStart = appState.currentWeekStart;
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);

        el.weekDisplay.textContent = `${formatDate(weekStart, {day:'numeric', month:'long'})} - ${formatDate(weekEnd, {day:'numeric', month:'long'})}`;

        el.daysGrid.innerHTML = '';
        let hasSelectableDay = false;
        for (let i = 0; i < 7; i++) {
            const dayDate = new Date(weekStart);
            dayDate.setDate(weekStart.getDate() + i);
            const dayKey = toYYYYMMDD(dayDate);
            
            const dayEl = document.createElement('div');
            dayEl.className = 'day';
            dayEl.dataset.date = dayKey;
            dayEl.innerHTML = `
                <div class="day__name">${formatDate(dayDate, {weekday: 'short'}).toUpperCase()}</div>
                <div class="day__date">${dayDate.getDate()}</div>
            `;
            
            const hasSlots = appState.allSlots.some(s => s.date.startsWith(dayKey));
            if (hasSlots) {
                dayEl.classList.add('has-slots', 'selectable');
                dayEl.addEventListener('click', () => handleDayClick(dayKey));
                hasSelectableDay = true;
            }
            if (dayKey === appState.selectedDate) {
                dayEl.classList.add('active');
            }
            el.daysGrid.appendChild(dayEl);
        }
        
        // If no date is selected or selected date has no slots, auto-select first available day
        if (hasSelectableDay && (!appState.selectedDate || !appState.allSlots.some(s => s.date.startsWith(appState.selectedDate)))) {
            const firstDayWithSlots = toYYYYMMDD(new Date(Math.min(...appState.allSlots.map(s => new Date(s.date)))));
            if (firstDayWithSlots) {
                appState.selectedDate = firstDayWithSlots;
                const activeDayEl = el.daysGrid.querySelector(`[data-date="${firstDayWithSlots}"]`);
                if (activeDayEl) activeDayEl.classList.add('active');
            }
        }
        renderSlotsForDate(appState.selectedDate);
      }

      function renderSlotsForDate(dateKey) {
          if (!dateKey) {
              el.slotsList.innerHTML = `<p style="color: var(--text-secondary); text-align: center; padding: 20px 0;">Выберите день выше, чтобы увидеть свободные слоты.</p>`;
              return;
          }
          const slotsForDay = appState.allSlots.filter(s => s.date.startsWith(dateKey));
          const selectedDay = new Date(dateKey);
          const title = `Свободные слоты на ${formatDate(selectedDay, {weekday: 'long', day:'numeric', month:'long'})}`;
          
          if (slotsForDay.length === 0) {
              el.slotsList.innerHTML = `<div class="section-title">${title}</div><p>На этот день слотов нет.</p>`;
              return;
          }

          el.slotsList.innerHTML = `
            <div class="section-title">${title}</div>
            ${slotsForDay.map(slot => {
                const trainer = appState.trainers[slot.trainer_id] || { name: 'Тренер' };
                const remaining = slot.capacity - slot.booked;
                const isFull = remaining <= 0;
                return `
                <div class="slot-card" data-slot-id="${slot.slot_id}">
                    <div class="slot-card__info">
                        <div class="slot-card__time">${slot.time}</div>
                        <div class="slot-card__details">Тренер: ${trainer.name} | Свободно: ${remaining}/${slot.capacity}</div>
                    </div>
                    <div class="slot-card__action">
                        <button class="btn" ${isFull ? 'disabled' : ''}>Записаться</button>
                    </div>
                </div>
                `
            }).join('')}
          `;
          el.slotsList.querySelectorAll('.btn').forEach(btn => {
              btn.addEventListener('click', handleBookingClick);
          });
      }

      function renderTrainers() {
          el.trainersGrid.innerHTML = Object.values(appState.trainers).map(trainer => `
            <div class="trainer-card">
                <div class="trainer-card__avatar"><img src="${trainer.avatar_url}" alt="${trainer.name}"></div>
                <div class="trainer-card__name">${trainer.name}</div>
                <div class="trainer-card__speciality">${trainer.speciality}</div>
                <a href="https://t.me/${trainer.tg_username}" target="_blank" class="trainer-card__contact-btn">Написать</a>
            </div>
          `).join('');
      }
      
      function renderProfile() {
          if (!appState.user) {
              el.profileSection.innerHTML = `
                <p>Чтобы записывать детей, пожалуйста, зарегистрируйтесь.</p>
                <form id="registration-form">
                    <div class="form-group"><label for="parent-name">Ваше ФИО</label><input type="text" id="parent-name" required></div>
                    <div class="form-group"><label for="parent-phone">Ваш телефон</label><input type="tel" id="parent-phone" required></div>
                    <hr style="border-color: var(--border-color); margin: 20px 0;">
                    <div class="form-group"><label for="child-name">Имя ребенка</label><input type="text" id="child-name" required></div>
                    <div class="form-group"><label for="child-dob">Дата рождения ребенка</label><input type="date" id="child-dob" required></div>
                    <button type="submit" class="submit-btn">Зарегистрироваться</button>
                </form>
              `;
              document.getElementById('registration-form').addEventListener('submit', handleRegistrationSubmit);
          } else {
              const hasChildren = appState.children.length > 0;
              el.profileSection.innerHTML = `
                <div class="child-switcher">${appState.children.map(child => `<div class="child-tab ${child.child_id === appState.selectedChildId ? 'active' : ''}" data-child-id="${child.child_id}">${child.child_name}</div>`).join('')}</div>
                ${hasChildren ? `<div class="balance-info">Осталось занятий: <span id="balance-display">${appState.balances[appState.selectedChildId]?.remaining || 0}</span></div>` : '<p>У вас пока не добавлено ни одного ребенка.</p>'}
              `;
              el.profileSection.querySelectorAll('.child-tab').forEach(tab => {
                  tab.addEventListener('click', () => handleChildSelect(tab.dataset.childId));
              });
          }
      }

      // --- EVENT HANDLERS ---
      async function handleRegistrationSubmit(event) {
          event.preventDefault();
          const btn = event.target.querySelector('button');
          btn.disabled = true; btn.textContent = 'Регистрация...';
          try {
              const response = await apiCall('register_parent', { 
                  parent: { full_name: document.getElementById('parent-name').value, phone: document.getElementById('parent-phone').value },
                  children: [{ child_name: document.getElementById('child-name').value, birthdate: document.getElementById('child-dob').value }]
              });
              appState.user = response.parent;
              appState.children = response.children;
              appState.balances = response.balances.reduce((acc, b) => ({...acc, [b.child_id]: b}), {});
              appState.selectedChildId = response.children[0]?.child_id;
              
              renderUserInfo();
              renderProfile();
              tg.showAlert('Вы успешно зарегистрированы!');
          } catch(e) {
              tg.showAlert(`Ошибка регистрации: ${e.message}`);
          } finally {
              btn.disabled = false; btn.textContent = 'Зарегистрироваться';
          }
      }
      
      function handleChildSelect(childId) {
          appState.selectedChildId = childId;
          renderProfile();
      }

      async function handleBookingClick(event) {
          const btn = event.target;
          const slotId = btn.closest('.slot-card').dataset.slotId;

          if (!appState.selectedChildId) {
              tg.showAlert('Пожалуйста, выберите ребенка для записи во вкладке "Мой профиль".');
              document.querySelector('.tab[data-tab="profile"]').click();
              return;
          }
          
          btn.disabled = true; btn.textContent = '...';

          try {
              const response = await apiCall('book', { slot_id: slotId, child_id: appState.selectedChildId });
              
              const slot = appState.allSlots.find(s => s.slot_id === slotId);
              if (slot) slot.booked++;
              
              appState.balances[appState.selectedChildId] = response.updatedBalance;
              
              renderSlotsForDate(appState.selectedDate);
              renderProfile();
              tg.showPopup({ title: 'Успех!', message: 'Ребенок успешно записан!'});
          } catch (e) {
              tg.showAlert(`Ошибка записи: ${e.message}`);
              btn.disabled = false; btn.textContent = 'Записаться';
          }
      }
      
      function handleDayClick(dateKey) {
          appState.selectedDate = dateKey;
          // We only need to re-render the calendar which will also trigger re-render of slots
          renderCalendar();
      }

      async function changeWeek(direction) {
        appState.currentWeekStart.setDate(appState.currentWeekStart.getDate() + (7 * direction));
        el.slotsList.innerHTML = '<p>Загрузка расписания...</p>';
        await fetchSlotsForCurrentWeek();
        // Reset selected date to the first day of the new week
        appState.selectedDate = null;
        renderCalendar();
      }
      
      async function fetchSlotsForCurrentWeek() {
          const from = appState.currentWeekStart;
          const to = new Date(from);
          to.setDate(from.getDate() + 6);
          try {
              appState.allSlots = await apiCall('slots', { from: toYYYYMMDD(from), to: toYYYYMMDD(to) });
          } catch (e) {
              appState.allSlots = [];
              el.slotsList.innerHTML = `<p style="color: var(--accent-red)">Не удалось загрузить расписание.</p>`;
          }
      }

      // --- INITIALIZATION ---
      async function init() {
        try {
          const bootstrapData = await apiCall('bootstrap');
          appState.user = bootstrapData.parent;
          appState.children = bootstrapData.children || [];
          appState.balances = (bootstrapData.balances || []).reduce((acc, b) => ({...acc, [b.child_id]: b}), {});
          appState.trainers = (bootstrapData.trainers || []).reduce((acc, t) => ({...acc, [t.trainer_id]: t}), {});
          if (appState.children.length > 0) {
              appState.selectedChildId = appState.children[0].child_id;
          }

          renderUserInfo();
          renderTrainers();
          renderProfile();

          // Init calendar - visual part first
          const today = new Date();
          appState.currentWeekStart = getStartOfWeek(today);
          appState.selectedDate = toYYYYMMDD(today);
          renderCalendar(); // Render empty calendar grid
          
          el.loader.style.display = 'none';
          el.mainContent.style.display = 'block';

          // Then fetch data for it
          await fetchSlotsForCurrentWeek();
          renderCalendar(); // Re-render calendar with slots data

          // General event listeners
          document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
              document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
              tab.classList.add('active');
              document.getElementById(tab.dataset.tab).classList.add('active');
            });
          });
          el.prevWeekBtn.addEventListener('click', () => changeWeek(-1));
          el.nextWeekBtn.addEventListener('click', () => changeWeek(1));

        } catch (error) {
          el.loader.textContent = 'Не удалось загрузить данные. Пожалуйста, перезапустите приложение.';
        }
      }

      init();
    });
  </script>
</body>
</html>

