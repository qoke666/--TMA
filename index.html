<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Карате — расписание и профиль</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --accent:#2B8CFF;
      --muted:#6c757d;
      --card-bg: #ffffff;
      --page-bg: #f4f7fb;
    }
    html,body{
      height:100%;
      margin:0;
      overflow-x:hidden;
    }
    body{
      background:var(--page-bg);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color:#222;
      padding: 16px;
      font-size:16px;
      -webkit-font-smoothing: antialiased;
    }

    /* nav menu */
    .menu{
      display:flex; gap:8px; flex-wrap: nowrap; margin-bottom: 24px; overflow-x: auto; scrollbar-width: none;
    }
    .menu::-webkit-scrollbar { display: none; }
    .menu .nav-item button{
      background:transparent; border:1px solid rgba(10,20,40,0.06); padding:10px 16px; border-radius:20px;
      color:#0b1a2b; font-weight:500; font-size:14px; white-space: nowrap; cursor: pointer; transition: background-color 0.2s, color 0.2s;
    }
    .menu .nav-item button.active{
      background: var(--accent); color: #ffffff;
      box-shadow: none; border-color: var(--accent);
    }
    .menu .nav-item button:hover{
      background: rgba(43,140,255,0.2);
    }

    /* back button */
    .back-btn{
      background: transparent;
      border: 1px solid rgba(10,20,40,0.06);
      padding: 10px 16px;
      border-radius: 20px;
      font-weight: 500;
      font-size: 14px;
      color: var(--accent);
      margin-bottom: 24px;
      display: inline-block;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .back-btn:hover{
      background: rgba(43,140,255,0.1);
    }

    /* container */
    .app {
      max-width: 800px;
      margin: 0 auto;
      padding: 0;
    }

    .card-soft{
      background:var(--card-bg);
      border-radius:16px;
      box-shadow: 0 6px 20px rgba(40,50,80,0.04);
      padding:20px;
      margin-bottom:24px;
    }

    /* schedule */
    .group-time {
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; padding:16px; border-radius:12px;
      transition: background-color 0.2s;
      background: linear-gradient(180deg, rgba(250,250,255,1), rgba(247,250,255,1));
      border: 1px solid rgba(20,30,60,0.03);
      margin-bottom: 12px;
    }
    .group-time:hover{ background: rgba(43,140,255,0.05); }

    .group-title{ font-weight:600; font-size:18px; }
    .group-hours{ color:var(--muted); font-weight:500; font-size:14px; }

    /* trainer */
    .trainer{
      display:flex; gap:10px; align-items:center;
    }
    .trainer .avatar{
      width:36px;height:36px;border-radius:50%;
      background:linear-gradient(135deg,#ffd89b,#ffb199);
      display:flex;align-items:center;justify-content:center;font-weight:600;color:#222;
      font-size:14px; border: 1px solid rgba(10,20,40,0.06);
    }
    .address{ color:var(--muted); font-size:14px; margin-bottom:8px; }

    /* profile section */
    #profileSection .form-control{ border-radius:8px; font-size:16px; padding:12px; border: 1px solid rgba(10,20,40,0.06); }
    .child-card {
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; padding:16px; border-radius:12px; border:1px solid rgba(10,20,40,0.035);
      background: linear-gradient(180deg,#fff,#fbfdff);
      margin-bottom: 12px;
    }
    .child-meta { color:var(--muted); font-size:14px; }
    .btn-ghost { background:transparent; border:1px solid rgba(10,20,40,0.06); border-radius:8px; padding:10px 20px; font-size:14px; font-weight:500; cursor: pointer; }

    /* responsive tweaks for Telegram WebApp */
    @media (max-width:768px){
      body { padding: 12px; }
      .trainer { flex-direction:column; align-items:flex-start; }
      .trainer .avatar { width:32px; height:32px; font-size:12px; }
      .group-time { flex-direction:column; align-items:flex-start; padding: 12px; }
      .card-soft { padding:16px; margin-bottom:16px; }
      .address { font-size:12px; }
      .row.g-3 { gap:10px !important; }
      .form-control { font-size:14px; padding:10px; }
      .btn { font-size:14px; padding:8px 16px; }
      .menu .nav-item button { font-size:12px; padding:8px 12px; }
      .back-btn { font-size:12px; padding:8px 12px; }
      iframe { height:120px; }
      .group-title { font-size:16px; }
      .group-hours { font-size:12px; }
    }
    @media (max-width:576px){
      .menu { flex-wrap: wrap; gap:6px; }
      .menu .nav-item button { font-size:10px; padding:6px 10px; }
      .back-btn { font-size:10px; padding:6px 10px; }
      .card-soft { padding:12px; margin-bottom:12px; }
      .group-time { padding: 10px; }
      .child-card { padding: 10px; }
      .btn-ghost { padding: 8px 12px; font-size:12px; }
    }
  </style>
</head>
<body>
  <main class="app">
    <!-- HOME -->
    <section id="homeSection" class="mb-3">
      <div class="card-soft">
        <h2 style="margin-bottom:8px;font-size:20px;font-weight:600">Расписание сегодня</h2>
        <p class="small" style="color:var(--muted); margin-bottom:8px;font-size:14px">Группы по возрасту — удобное распределение времени</p>
        <nav class="menu">
          <div class="nav-item"><button id="nav-home" class="active" onclick="showSection('home')">Главная</button></div>
          <div class="nav-item"><button id="nav-schedule" onclick="showSection('schedule')">Расписание</button></div>
          <div class="nav-item"><button id="nav-profile" onclick="showSection('profile')">Мой профиль</button></div>
        </nav>
        <div class="row g-3">
          <div class="col-md-4">
            <div class="group-time">
              <div>
                <div class="group-title">Новые школьники</div>
                <div class="group-hours">17:30 — 18:30</div>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="group-time">
              <div>
                <div class="group-title">Дошкольники</div>
                <div class="group-hours">18:30 — 19:30</div>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="group-time">
              <div>
                <div class="group-title">Старшая группа</div>
                <div class="group-hours">19:30 — 21:00</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card-soft d-flex gap-2 align-items-center">
        <div class="trainer">
          <div class="avatar">ПШ</div>
          <div>
            <div style="font-weight:600;font-size:18px">Павел Шестеров</div>
            <div class="small" style="color:var(--muted);font-size:14px">Главный тренер — 6 дан, опыт 12 лет</div>
            <div class="address">Студия: Апрельская ул., 1, Красноярск • Тел: +7 (900) 123-45-67</div>
          </div>
        </div>
        <div class="ms-auto text-end">
          <div class="small-muted" style="color:var(--muted);font-size:14px">Следующий набор</div>
          <div style="font-weight:600;font-size:16px">1 октября</div>
        </div>
      </div>

      <div class="card-soft">
        <h5 style="font-size:18px;font-weight:600;margin-bottom:8px">Как нас найти</h5>
        <p class="address">Проходим через арку, поднимаемся по лестнице — студия на 2 этаже. Рядом — станция метро "Победа".</p>
        <iframe
          src="https://www.google.com/maps?q=56.0105,92.8525&z=15&output=embed"
          style="width:100%;height:120px;border:0;border-radius:8px;margin-top:8px;"
          loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </section>

    <!-- SCHEDULE (separate page also) -->
    <section id="scheduleSection" class="mb-3" style="display:none;">
      <div class="card-soft">
        <button class="back-btn" onclick="showSection('home')">Назад</button>
        <h3 style="font-size:20px;font-weight:600;margin-bottom:8px">Полное расписание</h3>
        <p class="small" style="color:var(--muted);font-size:14px">Группы и время занятий</p>

        <div class="row g-3 mt-2">
          <div class="col-12 col-md-6">
            <div class="group-time">
              <div>
                <div class="group-title">Новые школьники</div>
                <div class="group-hours">17:30 — 18:30</div>
                <div class="small" style="color:var(--muted);margin-top:4px;font-size:14px">Возраст: 7–10 лет</div>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="group-time">
              <div>
                <div class="group-title">Дошкольники</div>
                <div class="group-hours">18:30 — 19:30</div>
                <div class="small" style="color:var(--muted);margin-top:4px;font-size:14px">Возраст: 4–6 лет</div>
              </div>
            </div>
          </div>

          <div class="col-12 mt-2">
            <div class="group-time">
              <div>
                <div class="group-title">Старшая группа</div>
                <div class="group-hours">19:30 — 21:00</div>
                <div class="small" style="color:var(--muted);margin-top:4px;font-size:14px">Возраст: 11+ лет</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="profileSection" style="display:none;">
      <div class="card-soft mb-2">
        <button class="back-btn" onclick="showSection('home')">Назад</button>
        <h3 style="font-size:20px;font-weight:600;margin-bottom:8px">Мой профиль</h3>
        <p class="small" style="color:var(--muted);font-size:14px">Здесь можно зарегистрировать ребёнка и посмотреть остатки занятий.</p>

        <div class="row g-3 mt-2">
          <div class="col-md-6">
            <div>
              <label class="form-label" style="font-size:14px;font-weight:500;margin-bottom:8px">Имя ребёнка</label>
              <input id="childNameInput" class="form-control" placeholder="Иван">
            </div>
            <div class="mt-2 d-flex gap-2">
              <button class="btn btn-primary" onclick="registerChild()" style="padding:10px 20px;border-radius:8px;font-size:14px;font-weight:600">Добавить</button>
              <button class="btn btn-outline-secondary btn-ghost" onclick="loadChildren()">Обновить</button>
            </div>
            <div class="small text-muted mt-2" style="font-size:12px">Родителям не нужно вводить количество занятий — только имя.</div>
          </div>

          <div class="col-md-6">
            <div style="font-weight:600;font-size:18px">Ваши дети</div>
            <div id="childrenList" class="mt-2">
              <div class="small text-muted" style="font-size:14px">Загрузка...</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card-soft">
        <h5 style="font-size:18px;font-weight:600;margin-bottom:8px">Контакты и заметки</h5>
        <p class="small" style="color:var(--muted);font-size:14px">Если нужно поменять остатки занятий — делаем это через админку тренера.</p>
      </div>
    </section>
  </main>

  <script>
    // === Настройки API ===
    // ЗАМЕНИТЕ gasUrl на ваш URL web app (deploy -> Web app -> URL /exec)
    const gasUrl = 'https://script.google.com/macros/s/AKfycbwdVdDFU-_w7VK_t-u0tTNbnm4YwhTspaBKUuq6JwUOlAqKiFLFPcQ_W1My1pTNKRl-7A/exec';

    // Telegram WebApp init (необязательно, но оставил)
    const webApp = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    try { webApp && webApp.ready(); } catch(e){ /* ignore */ }
    const user = webApp && webApp.initDataUnsafe ? webApp.initDataUnsafe.user : null;
    const telegramID = user ? user.id : 'test123';

    // === Навигация ===
    function setActiveNav(id) {
      document.querySelectorAll('.menu .nav-item button').forEach(b => b.classList.remove('active'));
      const btn = document.getElementById('nav-' + id);
      if (btn) btn.classList.add('active');
    }
    function showSection(name) {
      // sections: home, schedule, profile
      document.getElementById('homeSection').style.display = name === 'home' ? '' : 'none';
      document.getElementById('scheduleSection').style.display = name === 'schedule' ? '' : 'none';
      document.getElementById('profileSection').style.display = name === 'profile' ? '' : 'none';
      setActiveNav(name);
      if (name === 'profile') loadChildren();
    }

    // initial
    showSection('home');

    // === Работа с API: registerChild (form-urlencoded), loadChildren ===
    async function registerChild() {
      const nameInput = document.getElementById('childNameInput');
      const childName = (nameInput.value || '').trim();
      if (!childName) { alert('Введите имя ребёнка'); return; }

      try {
        const params = new URLSearchParams();
        params.append('action', 'addChild');
        params.append('telegramID', telegramID);
        params.append('childName', childName);

        const resp = await fetch(gasUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body: params.toString()
        });

        let result;
        try { result = await resp.json(); }
        catch (e) {
          const txt = await resp.text();
          console.error('Non-JSON response:', txt);
          alert('Ошибка сервера: ' + txt);
          return;
        }

        if (result.success) {
          nameInput.value = '';
          await loadChildren();
          showTinyToast('Ребёнок добавлен');
        } else {
          alert(result.message || 'Ошибка при добавлении');
        }
      } catch (err) {
        console.error(err);
        alert('Ошибка сети или неверный URL WebApp. Проверьте деплой и права доступа.');
      }
    }

    async function loadChildren() {
      const list = document.getElementById('childrenList');
      list.innerHTML = '<div class="small text-muted" style="font-size:14px">Загрузка...</div>';
      try {
        const resp = await fetch(`${gasUrl}?action=getData&telegramID=${telegramID}`);
        const data = await resp.json();
        // ожидаем { success: true, children: [...] } (в зависимости от реализации)
        const children = (data.children && Array.isArray(data.children)) ? data.children : [];

        if (children.length === 0) {
          list.innerHTML = '<div class="small text-muted" style="font-size:14px">Ребёнок(и) не зарегистрированы.</div>';
          return;
        }

        list.innerHTML = children.map(ch => {
          return `<div class="child-card">
                    <div>
                      <div style="font-weight:600;font-size:18px">${escapeHtml(ch.childName)}</div>
                      <div class="child-meta">Осталось занятий: <strong>${Number(ch.remaining)}</strong></div>
                    </div>
                    <div style="min-width:100px; text-align:right">
                      <button class="btn btn-sm btn-ghost" onclick="promptSetRemaining('${encodeURIComponent(ch.childName)}')">править</button>
                    </div>
                  </div>`;
        }).join('');
      } catch (err) {
        console.error(err);
        list.innerHTML = '<div class="small text-danger" style="font-size:14px">Ошибка загрузки. Проверьте URL и права WebApp.</div>';
      }
    }

    function escapeHtml(text){
      if (text === undefined || text === null) return '';
      return String(text)
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'",'&#039;');
    }

    function promptSetRemaining(childNameEncoded){
      const name = decodeURIComponent(childNameEncoded);
      alert('Если нужно изменить количество занятий для ' + name + ', свяжитесь с тренером — изменения делаются через админку.');
    }

    // tiny toast
    function showTinyToast(msg){
      const el = document.createElement('div');
      el.style.position = 'fixed';
      el.style.right = '16px';
      el.style.bottom = '16px';
      el.style.padding = '10px 16px';
      el.style.background = 'linear-gradient(90deg,var(--accent),#6ec3ff)';
      el.style.color = '#fff';
      el.style.borderRadius = '8px';
      el.style.boxShadow = '0 8px 20px rgba(10,20,40,0.12)';
      el.style.fontWeight = 500;
      el.style.fontSize = '14px';
      el.innerText = msg;
      document.body.appendChild(el);
      setTimeout(()=> el.style.opacity='0', 1700);
      setTimeout(()=> el.remove(), 2200);
    }
  </script>
</body>
</html>
