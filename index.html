<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Детская школа карате</title>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+JP:wght@400;500;700&display=swap');
    body { margin: 0; font-family: 'Inter', sans-serif; background: #1F2937; color: #F3F4F6; }
    #tsparticles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
    .menu-top { display: flex; justify-content: space-between; align-items: center; padding: 8px 16px; background: rgba(31, 41, 55, 0.9); backdrop-filter: blur(8px); position: sticky; top: 0; z-index: 20; }
    .menu { display: flex; justify-content: center; background: rgba(31, 41, 55, 0.9); backdrop-filter: blur(8px); padding: 6px 0; position: sticky; top: 48px; z-index: 10; }
    .menu ul { display: inline-flex; gap: 10px; padding: 0 16px; overflow-x: auto; white-space: nowrap; list-style: none; margin: 0; }
    .menu ul::-webkit-scrollbar { display: none; }
    .menu-item { padding: 6px 12px; border-radius: 6px; font-family: 'Noto Sans JP', sans-serif; font-weight: 600; font-size: 14px; cursor: pointer; color: #6B7280; transition: all 0.3s; }
    .menu-item.active, .menu-item:hover { background: #14B8A6; color: #F3F4F6; transform: scale(1.05); }
    .section { display: none; padding: 8px 16px; }
    .section.active { display: block; }
    .section-title { font-family: 'Noto Sans JP', sans-serif; font-size: 24px; font-weight: 700; margin: 16px 0; color: #14B8A6; text-align: center; }
    .card { background: rgba(55, 65, 81, 0.3); backdrop-filter: blur(8px); border: 1px solid rgba(20, 184, 166, 0.3); border-radius: 12px; padding: 12px; transition: transform 0.3s, box-shadow 0.3s; }
    .card:hover { transform: translateY(-4px); box-shadow: 0 6px 16px rgba(20, 184, 166, 0.2); }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
    .calendar-day { padding: 8px; border-radius: 6px; text-align: center; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .calendar-day.available { background: #34d399; color: #1F2937; }
    .calendar-day.available:hover { transform: scale(1.1); box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3); }
    .calendar-day.full { background: rgba(243, 244, 246, 0.1); color: #6B7280; cursor: not-allowed; }
    .calendar-header { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 12px; text-align: center; font-size: 12px; font-weight: 600; color: #6B7280; }
    .modal { visibility: hidden; opacity: 0; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8); background: #2a374a; border: 1px solid #14B8A6; border-radius: 16px; padding: 20px; z-index: 1000; width: 90%; max-width: 400px; transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
    .modal.active { visibility: visible; opacity: 1; transform: translate(-50%, -50%) scale(1); }
    .modal-overlay { visibility: hidden; opacity: 0; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 999; transition: all 0.3s; }
    .modal-overlay.active { visibility: visible; opacity: 1; }
    .modal h3 { margin: 0 0 10px; color: #14B8A6; font-size: 18px; text-align: center; }
    .modal .apply-form { display: flex; flex-direction: column; gap: 10px; }
    .modal .apply-form label { font-size: 13px; color: #9CA3AF; }
    .modal .apply-form input, .modal .apply-form select, .modal .apply-form textarea { padding: 8px; border: 1px solid #4B5563; border-radius: 5px; background: #374151; color: #F3F4F6; width: 100%; }
    .modal .apply-form button { padding: 10px; background: #14B8A6; color: #F3F4F6; border: none; border-radius: 5px; font-weight: 600; cursor: pointer; transition: background 0.3s; }
    .modal .apply-form button:hover { background: #10a38e; }
    .modal .apply-form button:disabled { background: #4B5563; cursor: not-allowed; }
    .modal .close-button { margin-top: 10px; padding: 10px; background: #4B5563; }
    .spinner { border: 3px solid rgba(20, 184, 166, 0.2); border-top: 3px solid #14B8A6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 12px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="tsparticles"></div>
  <div class="modal-overlay" id="modal-overlay"></div>

  <div class="menu-top">
    <div class="text-sm font-semibold">Красноярск, ул. Сакура, 12</div>
    <div class="flex items-center gap-2">
      <a href="#" class="text-teal-400 hover:text-orange-400"><i class="fab fa-telegram-plane"></i></a>
      <a href="#" class="text-teal-400 hover:text-orange-400"><i class="fab fa-instagram"></i></a>
    </div>
  </div>

  <nav class="menu">
    <ul>
      <li class="menu-item active" data-section="home">Главная</li>
      <li class="menu-item" data-section="booking">Запись</li>
    </ul>
  </nav>

  <main>
    <section id="home" class="section active">
      <h2 class="section-title">Расписание</h2>
      <div class="card" data-aos="fade-up">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-white" id="home-calendar-title"></h3>
          <div class="flex space-x-2">
            <button class="prev-month p-2 rounded-full hover:bg-white/10"><i class="fas fa-chevron-left"></i></button>
            <button class="next-month p-2 rounded-full hover:bg-white/10"><i class="fas fa-chevron-right"></i></button>
          </div>
        </div>
        <div class="calendar-header"><div>Пн</div><div>Вт</div><div>Ср</div><div>Чт</div><div>Пт</div><div>Сб</div><div>Вс</div></div>
        <div class="calendar-grid" id="calendar-grid"></div>
      </div>
    </section>

    <section id="booking" class="section">
      <h2 class="section-title">Запись на занятия</h2>
      <div class="card" data-aos="fade-up">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-white" id="booking-calendar-title"></h3>
          <div class="flex space-x-2">
            <button class="prev-month p-2 rounded-full hover:bg-white/10"><i class="fas fa-chevron-left"></i></button>
            <button class="next-month p-2 rounded-full hover:bg-white/10"><i class="fas fa-chevron-right"></i></button>
          </div>
        </div>
        <div class="calendar-header"><div>Пн</div><div>Вт</div><div>Ср</div><div>Чт</div><div>Пт</div><div>Сб</div><div>Вс</div></div>
        <div class="calendar-grid" id="booking-calendar-grid"></div>
        <p class="text-center text-sm text-gray-400 mt-4">Нажмите на доступный день, чтобы записаться.</p>
      </div>
    </section>
  </main>

  <div id="booking-modal" class="modal">
    <h3>Запись на занятие</h3>
    <p id="modal-date" class="text-gray-400 mb-4"></p>
    <form id="booking-form" class="apply-form" autocomplete="off">
      <input type="hidden" id="selected-date" name="selectedDate">
      <div><label for="child-name">Имя и фамилия ребенка</label><input type="text" id="child-name" name="childName" required></div>
      <div><label for="child-age">Возраст ребенка</label><input type="number" id="child-age" name="childAge" required></div>
      <div><label for="group-select">Выберите группу</label><select id="group-select" name="selectedGroup" required><option>Младшая (4-6 лет)</option><option>Средняя (7-10 лет)</option><option>Старшая (11-14 лет)</option></select></div>
      <div><label for="contact-info">Ваш контакт (Телефон/Telegram)</label><input type="text" id="contact-info" name="contactInfo" required></div>
      <div><label for="comments">Комментарии</label><textarea id="comments" name="comments" rows="2" placeholder="Например, есть ли у ребенка опыт..."></textarea></div>
      <button type="submit" id="submit-booking">Записаться</button>
      <button type="button" class="close-button" id="close-modal-button">Отмена</button>
      <div id="modal-spinner" class="spinner" style="display: none;"></div>
    </form>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.12.0/tsparticles.bundle.min.js"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ И НАСТРОЙКИ ---
      // !!! ВАЖНО: ЗАМЕНИТЕ ЭТОТ URL НА ВАШ ИЗ GOOGLE APPS SCRIPT !!!
      const WEB_APP_URL = 'https://script.google.com/macros/s/ВАШ_УНИКАЛЬНЫЙ_ИДЕНТИФИКАТОР/exec';
      
      const tg = window.Telegram?.WebApp;
      if (tg) tg.expand();
      const userData = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) 
        ? { id: tg.initDataUnsafe.user.id, username: tg.initDataUnsafe.user.username } 
        : { id: null, username: null };

      let currentDate = new Date();
      const availableWeekdays = [1, 3, 5]; // 1=Пн, 3=Ср, 5=Пт

      // --- ИНИЦИАЛИЗАЦИЯ БИБЛИОТЕК ---
      AOS.init({ duration: 600, once: true, offset: 20 });
      if (typeof tsParticles !== 'undefined') {
        tsParticles.load("tsparticles", { particles: { number: { value: 50 }, color: { value: "#14B8A6" }, shape: { type: "circle" }, opacity: { value: 0.4 }, size: { value: 2 }, move: { enable: true, speed: 0.5 } } });
      }

      // --- ОСНОВНАЯ ЛОГИКА ---
      
      /**
       * Отправляет событие в Google Apps Script.
       * @param {string} eventName - Название события (например, 'booking_request').
       * @param {object} additionalData - Дополнительные данные, специфичные для события.
       */
      async function trackEvent(eventName, additionalData = {}) {
        const payload = {
          event: eventName,
          user_id: userData.id,
          username: userData.username,
          timestamp: new Date().toISOString(),
          additional: additionalData,
        };

        try {
          const response = await fetch(WEB_APP_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Используем text/plain для обхода preflight
            body: JSON.stringify(payload)
          });
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const result = await response.json();
          if (result.status !== 'success') throw new Error(result.message);
          return result;
        } catch (error) {
          console.error('Ошибка при отправке события:', error);
          throw error;
        }
      }

      // --- UI ЭЛЕМЕНТЫ ---
      const modal = document.getElementById('booking-modal');
      const modalOverlay = document.getElementById('modal-overlay');
      const bookingForm = document.getElementById('booking-form');
      const modalSpinner = document.getElementById('modal-spinner');
      const submitButton = document.getElementById('submit-booking');

      // --- КАЛЕНДАРЬ ---
      function generateCalendar(gridId, titleId, date, isBooking) {
        const grid = document.getElementById(gridId);
        const title = document.getElementById(titleId);
        grid.innerHTML = '';
        const month = date.getMonth();
        const year = date.getFullYear();
        title.textContent = `${date.toLocaleString('ru', { month: 'long' })} ${year}`;
        const firstDayOfMonth = new Date(year, month, 1);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const startDayOfWeek = (firstDayOfMonth.getDay() + 6) % 7;

        for (let i = 0; i < startDayOfWeek; i++) grid.insertAdjacentHTML('beforeend', '<div></div>');

        for (let day = 1; day <= daysInMonth; day++) {
          const currentDayDate = new Date(year, month, day);
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          const dayElement = document.createElement('div');
          dayElement.textContent = day;
          dayElement.classList.add('calendar-day');

          if (currentDayDate < today) {
            dayElement.classList.add('full');
          } else if (availableWeekdays.includes(currentDayDate.getDay())) {
            dayElement.classList.add('available');
            if (isBooking) dayElement.addEventListener('click', () => openModal(currentDayDate));
          } else {
            dayElement.classList.add('full');
          }
          grid.appendChild(dayElement);
        }
      }
      
      function updateAllCalendars() {
        generateCalendar('calendar-grid', 'home-calendar-title', currentDate, false);
        generateCalendar('booking-calendar-grid', 'booking-calendar-title', currentDate, true);
      }

      // --- МОДАЛЬНОЕ ОКНО ---
      function openModal(date) {
        document.getElementById('modal-date').textContent = `на ${date.toLocaleDateString('ru')}`;
        document.getElementById('selected-date').value = date.toLocaleDateString('ru');
        modal.classList.add('active');
        modalOverlay.classList.add('active');
      }

      function closeModal() {
        modal.classList.remove('active');
        modalOverlay.classList.remove('active');
        bookingForm.reset();
      }
      
      // --- ОБРАБОТЧИКИ СОБЫТИЙ ---
      document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', (e) => {
          document.querySelector('.menu-item.active').classList.remove('active');
          e.currentTarget.classList.add('active');
          document.querySelector('.section.active').classList.remove('active');
          document.getElementById(e.currentTarget.dataset.section).classList.add('active');
          window.scrollTo(0, 0);
        });
      });

      document.querySelectorAll('.prev-month').forEach(btn => btn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        updateAllCalendars();
      }));

      document.querySelectorAll('.next-month').forEach(btn => btn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        updateAllCalendars();
      }));

      document.getElementById('close-modal-button').addEventListener('click', closeModal);
      modalOverlay.addEventListener('click', closeModal);

      bookingForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        modalSpinner.style.display = 'block';
        submitButton.disabled = true;

        const formData = new FormData(bookingForm);
        const data = Object.fromEntries(formData.entries());

        try {
          await trackEvent('booking_request', data);
          if (tg) tg.showPopup({ title: 'Успешно!', message: 'Вы записаны! Мы скоро с вами свяжемся.' });
          else alert('Вы успешно записаны!');
          closeModal();
        } catch (error) {
          if (tg) tg.showPopup({ title: 'Ошибка', message: `Не удалось отправить заявку. ${error.message}` });
          else alert(`Ошибка: ${error.message}`);
        } finally {
          modalSpinner.style.display = 'none';
          submitButton.disabled = false;
        }
      });

      // --- ПЕРВИЧНЫЙ ЗАПУСК ---
      updateAllCalendars();
      trackEvent('webapp_open');
    });
  </script>
</body>
</html>
