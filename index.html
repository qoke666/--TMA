<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Карате — расписание и профиль</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --accent:#2B8CFF;
      --muted:#6c757d;
      --card-bg: #ffffff;
      --page-bg: #f4f7fb;
    }
    html,body{
      height:100%;
      margin:0;
      overflow-x:hidden;
    }
    body{
      background:var(--page-bg);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color:#222;
      padding-top: 60px;
      font-size:14px;
    }

    /* Navbar */
    .topbar{
      position: fixed;
      top: 0; left:0; right:0;
      height:50px;
      background:linear-gradient(90deg, rgba(255,255,255,0.85), rgba(255,255,255,0.75));
      backdrop-filter: blur(6px);
      display:flex;
      align-items:center;
      box-shadow: 0 4px 12px rgba(30,40,60,0.06);
      z-index: 1000;
      padding: 0 8px;
    }
    .brand{
      display:flex; align-items:center; gap:6px;
      font-weight:700; color:var(--accent);
      font-size:13px;
      flex-shrink: 0;
    }
    .brand .logo{
      width:28px;height:28px;border-radius:6px;
      background:linear-gradient(135deg,var(--accent),#7cc3ff);
      display:flex;align-items:center;justify-content:center;color:white;font-weight:700;
      box-shadow: 0 4px 12px rgba(43,140,255,0.18);
      font-size:11px;
    }
    .topbar-address{
      font-size:12px;
      font-weight:600;
      color:#0b1a2b;
      text-align:right;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 50%;
    }

    /* nav menu */
    .menu{
      display:flex; gap:4px; flex-wrap: nowrap; margin-bottom: 8px;
    }
    .menu .nav-item button{
      background:transparent; border:0; padding:4px 8px; border-radius:6px;
      color:#0b1a2b; font-weight:600; font-size:12px;
    }
    .menu .nav-item button.active{
      background: rgba(43,140,255,0.12); color: var(--accent);
      box-shadow: none;
    }
    .menu .nav-item button:hover{
      background: rgba(43,140,255,0.2);
      transform: translateY(-1px);
    }

    /* back button */
    .back-btn{
      background: transparent;
      border: 1px solid rgba(10,20,40,0.06);
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 12px;
      color: var(--accent);
      margin-bottom: 8px;
      display: inline-block;
    }
    .back-btn:hover{
      background: rgba(43,140,255,0.1);
      transform: translateY(-1px);
    }

    /* container */
    .app {
      max-width: 100%;
      margin: 0 auto;
      padding: 8px;
    }

    .card-soft{
      background:var(--card-bg);
      border-radius:8px;
      box-shadow: 0 6px 20px rgba(40,50,80,0.04);
      padding:10px;
      margin-bottom:10px;
    }

    /* schedule */
    .group-time {
      display:flex; justify-content:space-between; align-items:center;
      gap:6px; padding:6px; border-radius:6px;
      transition: transform .18s ease, box-shadow .18s;
      background: linear-gradient(180deg, rgba(250,250,255,1), rgba(247,250,255,1));
      border: 1px solid rgba(20,30,60,0.03);
    }
    .group-time:hover{ transform: translateY(-2px); box-shadow: 0 8px 20px rgba(22,35,62,0.06); }

    .group-title{ font-weight:700; font-size:0.9rem; }
    .group-hours{ color:var(--muted); font-weight:600; font-size:0.8rem; }

    /* trainer */
    .trainer{
      display:flex; gap:8px; align-items:center;
    }
    .trainer .avatar{
      width:48px;height:48px;border-radius:8px;
      background:linear-gradient(135deg,#ffd89b,#ffb199);
      display:flex;align-items:center;justify-content:center;font-weight:700;color:#222;
      font-size:13px; box-shadow: 0 6px 20px rgba(255,170,100,0.12);
    }
    .address{ color:var(--muted); font-size:0.75rem; margin-top:4px; }

    /* profile section */
    #profileSection .form-control{ border-radius:6px; font-size:0.8rem; padding:5px; }
    .child-card {
      display:flex; justify-content:space-between; align-items:center;
      gap:6px; padding:6px; border-radius:6px; border:1px solid rgba(10,20,40,0.035);
      background: linear-gradient(180deg,#fff,#fbfdff);
    }
    .child-meta { color:var(--muted); font-size:0.75rem; }
    .btn-ghost { background:transparent; border:1px solid rgba(10,20,40,0.06); border-radius:6px; padding:3px 6px; font-size:0.75rem; }

    /* responsive tweaks for Telegram WebApp */
    @media (max-width:768px){
      body { padding-top:70px; }
      .topbar { height:60px; flex-wrap:wrap; padding:6px 6px; }
      .brand { font-size:12px; }
      .brand .logo { width:26px; height:26px; font-size:10px; }
      .topbar-address { font-size:11px; max-width: 45%; }
      .trainer { flex-direction:column; align-items:flex-start; }
      .trainer .avatar { width:36px; height:36px; font-size:11px; }
      .group-time { flex-direction:column; align-items:flex-start; }
      .app { padding:6px; }
      .card-soft { padding:8px; margin-bottom:8px; }
      .address { font-size:0.7rem; }
      .row.g-3 { gap:6px !important; }
      .form-control { font-size:0.75rem; padding:4px; }
      .btn { font-size:0.75rem; padding:4px 6px; }
      .menu .nav-item button { font-size:11px; padding:3px 6px; }
      .back-btn { font-size:11px; padding:3px 6px; }
      iframe { height:160px; }
    }
    @media (max-width:576px){
      .topbar { height:70px; }
      .brand { flex-direction:column; align-items:flex-start; gap:2px; }
      .topbar-address { font-size:10px; max-width: 40%; }
      .group-title { font-size:0.85rem; }
      .group-hours { font-size:0.75rem; }
      .menu { flex-wrap: wrap; gap:3px; }
      .menu .nav-item button { font-size:10px; padding:3px 5px; }
      .back-btn { font-size:10px; padding:3px 5px; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo">KS</div>
      <div>
        Карате<br><small style="font-weight:600;color:#1f2b3a;opacity:.6">Студия — расписание</small>
      </div>
    </div>

    <div class="ms-auto topbar-address">Апрельская ул., 1</div>
  </div>

  <main class="app">
    <!-- HOME -->
    <section id="homeSection" class="mb-3">
      <div class="card-soft mb-3">
        <h2 style="margin-bottom:6px;font-size:1.05rem">Расписание сегодня</h2>
        <p class="small" style="color:var(--muted); margin-bottom:8px;">Группы по возрасту — удобное распределение времени</p>
        <nav class="menu">
          <div class="nav-item"><button id="nav-home" class="active" onclick="showSection('home')">Главная</button></div>
          <div class="nav-item"><button id="nav-schedule" onclick="showSection('schedule')">Расписание</button></div>
          <div class="nav-item"><button id="nav-profile" onclick="showSection('profile')">Мой профиль</button></div>
        </nav>
        <div class="row g-3">
          <div class="col-md-4">
            <div class="group-time">
              <div>
                <div class="group-title">Новые школьники</div>
                <div class="group-hours">17:30 — 18:30</div>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="group-time">
              <div>
                <div class="group-title">Дошкольники</div>
                <div class="group-hours">18:30 — 19:30</div>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="group-time">
              <div>
                <div class="group-title">Старшая группа</div>
                <div class="group-hours">19:30 — 21:00</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card-soft mb-3 d-flex gap-2 align-items-center">
        <div class="trainer">
          <div class="avatar">ПШ</div>
          <div>
            <div style="font-weight:700">Павел Шестеров</div>
            <div class="small" style="color:var(--muted)">Главный тренер — 6 дан, опыт 12 лет</div>
            <div class="address">Студия: Апрельская ул., 1, Красноярск • Тел: +7 (900) 123-45-67</div>
          </div>
        </div>
        <div class="ms-auto text-end">
          <div class="small-muted" style="color:var(--muted)">Следующий набор</div>
          <div style="font-weight:700">1 октября</div>
        </div>
      </div>

      <div class="card-soft">
        <h5 style="font-size:0.95rem">Как нас найти</h5>
        <p class="address">Проходим через арку, поднимаемся по лестнице — студия на 2 этаже. Рядом — станция метро "Победа".</p>
        <iframe
          src="https://www.google.com/maps?q=56.0105,92.8525&z=15&output=embed"
          style="width:100%;height:160px;border:0;border-radius:8px;margin-top:6px;"
          loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </section>

    <!-- SCHEDULE (separate page also) -->
    <section id="scheduleSection" class="mb-3" style="display:none;">
      <div class="card-soft">
        <button class="back-btn" onclick="showSection('home')">Назад</button>
        <h3 style="font-size:1.05rem">Полное расписание</h3>
        <p class="small" style="color:var(--muted)">Группы и время занятий</p>

        <div class="row g-3 mt-2">
          <div class="col-12 col-md-6">
            <div class="group-time">
              <div>
                <div class="group-title">Новые школьники</div>
                <div class="group-hours">17:30 — 18:30</div>
                <div class="small" style="color:var(--muted);margin-top:4px">Возраст: 7–10 лет</div>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="group-time">
              <div>
                <div class="group-title">Дошкольники</div>
                <div class="group-hours">18:30 — 19:30</div>
                <div class="small" style="color:var(--muted);margin-top:4px">Возраст: 4–6 лет</div>
              </div>
            </div>
          </div>

          <div class="col-12 mt-2">
            <div class="group-time">
              <div>
                <div class="group-title">Старшая группа</div>
                <div class="group-hours">19:30 — 21:00</div>
                <div class="small" style="color:var(--muted);margin-top:4px">Возраст: 11+ лет</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="profileSection" style="display:none;">
      <div class="card-soft mb-2">
        <button class="back-btn" onclick="showSection('home')">Назад</button>
        <h3 style="font-size:1.05rem">Мой профиль</h3>
        <p class="small" style="color:var(--muted)">Здесь можно зарегистрировать ребёнка и посмотреть остатки занятий.</p>

        <div class="row g-3 mt-2">
          <div class="col-md-6">
            <div>
              <label class="form-label" style="font-size:0.8rem">Имя ребёнка</label>
              <input id="childNameInput" class="form-control" placeholder="Иван">
            </div>
            <div class="mt-2 d-flex gap-2">
              <button class="btn btn-primary" onclick="registerChild()">Добавить</button>
              <button class="btn btn-outline-secondary" onclick="loadChildren()">Обновить</button>
            </div>
            <div class="small text-muted mt-2" style="font-size:0.7rem">Родителям не нужно вводить количество занятий — только имя.</div>
          </div>

          <div class="col-md-6">
            <div style="font-weight:700;font-size:0.9rem">Ваши дети</div>
            <div id="childrenList" class="mt-2">
              <div class="small text-muted">Загрузка...</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card-soft">
        <h5 style="font-size:0.95rem">Контакты и заметки</h5>
        <p class="small" style="color:var(--muted)">Если нужно поменять остатки занятий — делаем это через админку тренера.</p>
      </div>
    </section>
  </main>

  <script>
    // === Настройки API ===
    // ЗАМЕНИТЕ gasUrl на ваш URL web app (deploy -> Web app -> URL /exec)
    const gasUrl = 'https://script.google.com/macros/s/AKfycbwdVdDFU-_w7VK_t-u0tTNbnm4YwhTspaBKUuq6JwUOlAqKiFLFPcQ_W1My1pTNKRl-7A/exec';

    // Telegram WebApp init (необязательно, но оставил)
    const webApp = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    try { webApp && webApp.ready(); } catch(e){ /* ignore */ }
    const user = webApp && webApp.initDataUnsafe ? webApp.initDataUnsafe.user : null;
    const telegramID = user ? user.id : 'test123';

    // === Навигация ===
    function setActiveNav(id) {
      document.querySelectorAll('.menu .nav-item button').forEach(b => b.classList.remove('active'));
      const btn = document.getElementById('nav-' + id);
      if (btn) btn.classList.add('active');
    }
    function showSection(name) {
      // sections: home, schedule, profile
      document.getElementById('homeSection').style.display = name === 'home' ? '' : 'none';
      document.getElementById('scheduleSection').style.display = name === 'schedule' ? '' : 'none';
      document.getElementById('profileSection').style.display = name === 'profile' ? '' : 'none';
      setActiveNav(name);
      if (name === 'profile') loadChildren();
    }

    // initial
    showSection('home');

    // === Работа с API: registerChild (form-urlencoded), loadChildren ===
    async function registerChild() {
      const nameInput = document.getElementById('childNameInput');
      const childName = (nameInput.value || '').trim();
      if (!childName) { alert('Введите имя ребёнка'); return; }

      try {
        const params = new URLSearchParams();
        params.append('action', 'addChild');
        params.append('telegramID', telegramID);
        params.append('childName', childName);

        const resp = await fetch(gasUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body: params.toString()
        });

        let result;
        try { result = await resp.json(); }
        catch (e) {
          const txt = await resp.text();
          console.error('Non-JSON response:', txt);
          alert('Ошибка сервера: ' + txt);
          return;
        }

        if (result.success) {
          nameInput.value = '';
          await loadChildren();
          showTinyToast('Ребёнок добавлен');
        } else {
          alert(result.message || 'Ошибка при добавлении');
        }
      } catch (err) {
        console.error(err);
        alert('Ошибка сети или неверный URL WebApp. Проверьте деплой и права доступа.');
      }
    }

    async function loadChildren() {
      const list = document.getElementById('childrenList');
      list.innerHTML = '<div class="small text-muted">Загрузка...</div>';
      try {
        const resp = await fetch(`${gasUrl}?action=getData&telegramID=${telegramID}`);
        const data = await resp.json();
        // ожидаем { success: true, children: [...] } (в зависимости от реализации)
        const children = (data.children && Array.isArray(data.children)) ? data.children : [];

        if (children.length === 0) {
          list.innerHTML = '<div class="small text-muted">Ребёнок(и) не зарегистрированы.</div>';
          return;
        }

        list.innerHTML = children.map(ch => {
          return `<div class="mb-2 child-card">
                    <div>
                      <div style="font-weight:700">${escapeHtml(ch.childName)}</div>
                      <div class="child-meta">Осталось занятий: <strong>${Number(ch.remaining)}</strong></div>
                    </div>
                    <div style="min-width:100px; text-align:right">
                      <button class="btn btn-sm btn-ghost" onclick="promptSetRemaining('${encodeURIComponent(ch.childName)}')">править</button>
                    </div>
                  </div>`;
        }).join('');
      } catch (err) {
        console.error(err);
        list.innerHTML = '<div class="small text-danger">Ошибка загрузки. Проверьте URL и права WebApp.</div>';
      }
    }

    function escapeHtml(text){
      if (text === undefined || text === null) return '';
      return String(text)
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'",'&#039;');
    }

    function promptSetRemaining(childNameEncoded){
      // Простой placeholder: тренер/админ должен менять количество в таблице; здесь можно подать подсказку.
      const name = decodeURIComponent(childNameEncoded);
      alert('Если нужно изменить количество занятий для ' + name + ', свяжитесь с тренером — изменения делаются через админку.');
    }

    // tiny toast
    function showTinyToast(msg){
      const el = document.createElement('div');
      el.style.position = 'fixed';
      el.style.right = '12px';
      el.style.bottom = '12px';
      el.style.padding = '8px 12px';
      el.style.background = 'linear-gradient(90deg,var(--accent),#6ec3ff)';
      el.style.color = '#fff';
      el.style.borderRadius = '8px';
      el.style.boxShadow = '0 8px 20px rgba(10,20,40,0.12)';
      el.style.fontWeight = 600;
      el.style.fontSize = '12px';
      el.innerText = msg;
      document.body.appendChild(el);
      setTimeout(()=> el.style.opacity='0', 1700);
      setTimeout(()=> el.remove(), 2200);
    }
  </script>
</body>
</html>
