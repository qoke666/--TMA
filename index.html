<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Детская Студия</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-main: #101010;
      --bg-secondary: #1C1C1C;
      --text-main: #FFFFFF;
      --text-secondary: #8E8E93;
      --accent-blue: #007AFF;
      --accent-green: #34C759;
      --accent-red: #FF3B30;
      --border-color: #2D2D2D;
    }

    @font-face {
      font-family: 'Inter';
      src: url('https://rsms.me/inter/font-files/Inter-Regular.woff2?v=3.19') format('woff2');
      font-weight: 400;
      font-style: normal;
    }

    @font-face {
      font-family: 'Inter';
      src: url('https://rsms.me/inter/font-files/Inter-Medium.woff2?v=3.19') format('woff2');
      font-weight: 500;
      font-style: normal;
    }

    @font-face {
      font-family: 'Inter';
      src: url('https://rsms.me/inter/font-files/Inter-SemiBold.woff2?v=3.19') format('woff2');
      font-weight: 600;
      font-style: normal;
    }

    @font-face {
      font-family: 'Inter';
      src: url('https://rsms.me/inter/font-files/Inter-Bold.woff2?v=3.19') format('woff2');
      font-weight: 700;
      font-style: normal;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      background-color: var(--bg-main);
      color: var(--text-main);
      padding: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .header__logo svg {
      width: 40px;
      height: 40px;
    }

    .header__user {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header__user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .header__user-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .header__user-name {
      font-weight: 500;
    }

    .promo {
      background-color: var(--bg-secondary);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
    }

    .promo__text {
      flex: 1;
    }

    .promo__title {
      font-size: 24px;
      font-weight: 700;
      margin: 0 0 8px 0;
    }

    .promo__subtitle {
      font-size: 16px;
      color: var(--text-secondary);
      margin: 0;
    }

    .promo__image img {
      width: 120px;
      height: 120px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      overflow-x: auto;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .tabs::-webkit-scrollbar {
      display: none;
    }

    .tab {
      padding: 10px 16px;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      cursor: pointer;
      font-weight: 500;
      white-space: nowrap;
      transition: background-color 0.2s, color 0.2s;
    }

    .tab.active {
      background-color: var(--accent-blue);
      color: var(--text-main);
      border-color: var(--accent-blue);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .calendar-container {
      background-color: var(--bg-secondary);
      border-radius: 16px;
      padding: 20px;
    }

    .week-selector {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .week-selector__arrow {
      cursor: pointer;
      padding: 8px;
    }

    .week-selector__arrow svg {
      width: 24px;
      height: 24px;
      stroke: var(--text-secondary);
    }

    .week-selector__date {
      font-size: 18px;
      font-weight: 600;
    }

    .days-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      margin-bottom: 20px;
      text-align: center;
    }

    .day {
      padding: 10px 5px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .day.active {
      background-color: var(--accent-blue);
    }

    .day__name {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .day__date {
      font-weight: 600;
    }

    .slots-list .slot-card {
      background-color: var(--bg-main);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .slot-card__info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .slot-card__time {
      font-size: 18px;
      font-weight: 600;
    }

    .slot-card__details {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .slot-card__action {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .slot-card__action select {
      background-color: var(--bg-secondary);
      color: var(--text-main);
      border: 1px solid var(--border-color);
      padding: 8px;
      border-radius: 8px;
      font-size: 14px;
    }

    .slot-card__action .btn {
      background-color: var(--accent-blue);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .slot-card__action .btn:hover {
      opacity: 0.8;
    }

    .slot-card__action .btn:disabled {
      background-color: var(--text-secondary);
      cursor: not-allowed;
    }

    .trainers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 16px;
    }

    .trainer-card {
      background-color: var(--bg-secondary);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
    }

    .trainer-card__avatar img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 12px;
      border: 2px solid var(--border-color);
    }

    .trainer-card__name {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .trainer-card__speciality {
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .trainer-card__contact-btn {
      display: inline-block;
      background-color: var(--bg-main);
      color: var(--text-main);
      border: 1px solid var(--border-color);
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 500;
      text-decoration: none;
    }

    .profile-section {
      background-color: var(--bg-secondary);
      border-radius: 16px;
      padding: 20px;
    }

    .profile-section p {
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .child-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }

    .child-form input {
      background-color: var(--bg-main);
      color: var(--text-main);
      border: 1px solid var(--border-color);
      padding: 10px;
      border-radius: 8px;
      font-size: 16px;
    }

    .child-form button {
      background-color: var(--accent-blue);
      color: white;
      border: none;
      padding: 10px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }

    .child-form button:hover {
      opacity: 0.8;
    }

    .child-selector {
      margin-bottom: 20px;
    }

    .child-selector select {
      background-color: var(--bg-secondary);
      color: var(--text-main);
      border: 1px solid var(--border-color);
      padding: 10px;
      border-radius: 8px;
      font-size: 16px;
      width: 100%;
    }

    .child-info {
      margin-bottom: 20px;
    }

    .child-info__balance {
      font-size: 16px;
      color: var(--text-secondary);
    }

    .child-info__history {
      margin-top: 16px;
    }

    .child-info__history-item {
      padding: 10px;
      border-bottom: 1px solid var(--border-color);
      font-size: 14px;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="header__logo">
        <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="20" cy="20" r="20" fill="white"/>
          <path d="M20 31.6667C26.4435 31.6667 31.6667 26.4435 31.6667 20C31.6667 13.5565 26.4435 8.33334 20 8.33334C13.5565 8.33334 8.33337 13.5565 8.33337 20C8.33337 26.4435 13.5565 31.6667 20 31.6667Z" fill="#007AFF"/>
        </svg>
      </div>
      <div class="header__user">
        <div class="header__user-avatar"><img id="user-avatar" src="" alt=""></div>
        <div class="header__user-name" id="user-name">Загрузка...</div>
      </div>
    </header>

    <main>
      <section class="promo">
        <div class="promo__text">
          <h1 class="promo__title">Запись на занятия</h1>
          <p class="promo__subtitle">Выберите удобное время для вашего ребенка и запишитесь в один клик.</p>
        </div>
        <div class="promo__image">
          <img src="https://em-content.zobj.net/source/apple/354/person-cartwheeling_1f938.png" alt="Гимнастика">
        </div>
      </section>

      <nav class="tabs">
        <div class="tab active" data-tab="schedule">Расписание</div>
        <div class="tab" data-tab="trainers">Тренеры</div>
        <div class="tab" data-tab="profile">Мой профиль</div>
      </nav>

      <div class="tab-content active" id="schedule">
        <div class="calendar-container">
          <div class="child-selector">
            <select id="child-select-schedule">
              <option value="">Выберите ребенка</option>
            </select>
          </div>
          <div class="week-selector">
            <div class="week-selector__arrow" id="prev-week">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg>
            </div>
            <div class="week-selector__date" id="week-date"></div>
            <div class="week-selector__arrow" id="next-week">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" /></svg>
            </div>
          </div>
          <div class="days-grid" id="days-grid"></div>
          <div class="slots-list">
            <div class="section-title" id="slots-title"></div>
          </div>
        </div>
      </div>

      <div class="tab-content" id="trainers">
        <div class="section-title">Наши тренеры</div>
        <div class="trainers-grid" id="trainers-grid"></div>
      </div>

      <div class="tab-content" id="profile">
        <div class="section-title">Профиль</div>
        <div class="profile-section">
          <div class="child-form">
            <input type="text" id="parent-telegram" placeholder="Telegram родителя (@username)" pattern="@[A-Za-z0-9_]{5,}" required>
            <input type="text" id="child-name" placeholder="Имя ребенка" required>
            <input type="date" id="child-birthdate" placeholder="Дата рождения" required>
            <button id="add-child">Добавить ребенка</button>
          </div>
          <div class="child-selector">
            <select id="child-select-profile">
              <option value="">Выберите ребенка</option>
            </select>
          </div>
          <div class="child-info" id="child-info" style="display: none;">
            <h3 id="child-info-name">Имя ребенка</h3>
            <p class="child-info__balance" id="child-info-balance">Остаток занятий: 0</p>
            <div class="child-info__history" id="child-info-history">
              <div class="section-title">История записей</div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const tg = window.Telegram.WebApp;
      tg.expand();

      // API endpoint (replace with your Google Apps Script Web App URL)
      const API_URL = 'https://script.google.com/macros/s/AKfycbwdVdDFU-_w7VK_t-u0tTNbnm4YwhTspaBKUuq6JwUOlAqKiFLFPcQ_W1My1pTNKRl-7A/exec'; // Замените на реальный URL

      // User info
      let user_id = null, username = null, first_name = null;
      if (tg.initDataUnsafe?.user) {
        ({ id: user_id, username, first_name } = tg.initDataUnsafe.user);
        document.getElementById('user-name').textContent = first_name || 'Пользователь';
      } else {
        document.getElementById('user-name').textContent = 'Гость';
        alert('Ошибка: Не удалось получить данные пользователя Telegram');
        return;
      }

      // State
      let children = [];
      let balances = [];
      let trainers = [];
      let slots = [];
      let currentWeekStart = new Date('2025-09-01'); // Начало текущей недели
      let selectedChildId = null;
      let selectedDate = '2025-09-03'; // Текущая дата по умолчанию

      // Generate UUID
      const generateUUID = () => {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
          const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      };

      // Track event
      const trackEvent = (event, payload = {}) => {
        const data = {
          action: event,
          initData: tg.initData,
          user_id,
          username,
          first_name,
          response_id: generateUUID(),
          ...payload
        };
        console.log(`Tracking event: ${event}`, data);
        fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
          mode: 'no-cors'
        }).then(() => {
          console.log(`Event ${event} sent successfully`);
        }).catch(error => {
          console.error(`Error tracking ${event}:`, error);
        });
      };

      // Format date
      const formatDate = (date) => {
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
      };

      // Get Monday of the week
      const getMonday = (date) => {
        const d = new Date(date);
        const day = d.getDay();
        const diff = day === 0 ? 6 : day - 1;
        d.setDate(d.getDate() - diff);
        return d;
      };

      // Update child selectors
      const updateChildSelectors = () => {
        const scheduleSelect = document.getElementById('child-select-schedule');
        const profileSelect = document.getElementById('child-select-profile');
        scheduleSelect.innerHTML = '<option value="">Выберите ребенка</option>';
        profileSelect.innerHTML = '<option value="">Выберите ребенка</option>';
        
        children.forEach(child => {
          const option = document.createElement('option');
          option.value = child.child_id;
          option.textContent = child.child_name;
          scheduleSelect.appendChild(option.cloneNode(true));
          profileSelect.appendChild(option);
        });

        if (selectedChildId) {
          scheduleSelect.value = selectedChildId;
          profileSelect.value = selectedChildId;
          updateChildInfo(selectedChildId);
        }
      };

      // Update child info
      const updateChildInfo = (childId) => {
        const childInfo = document.getElementById('child-info');
        const child = children.find(c => c.child_id === childId);
        if (child) {
          document.getElementById('child-info-name').textContent = child.child_name;
          const balance = balances.find(b => b.child_id === childId);
          document.getElementById('child-info-balance').textContent = `Остаток занятий: ${balance ? balance.remaining : 0}`;
          
          const historyContainer = document.getElementById('child-info-history');
          historyContainer.innerHTML = '<div class="section-title">История записей</div>';
          const payload = {
            action: 'bookings',
            initData: tg.initData,
            user_id,
            username,
            first_name,
            child_id: childId
          };
          fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }).then(response => response.json()).then(data => {
            if (data.success && data.bookings) {
              if (data.bookings.length === 0) {
                historyContainer.innerHTML += '<p>Нет записей</p>';
              } else {
                data.bookings.forEach(booking => {
                  const slot = slots.find(s => s.slot_id === booking.slot_id);
                  if (slot) {
                    const item = document.createElement('div');
                    item.className = 'child-info__history-item';
                    item.textContent = `Занятие: ${slot.time} | ${slot.date} | Тренер: ${trainers.find(t => t.trainer_id === slot.trainer_id)?.name || 'Неизвестно'}`;
                    historyContainer.appendChild(item);
                  }
                });
              }
            }
            childInfo.style.display = 'block';
          }).catch(error => {
            console.error('Error fetching bookings:', error);
            historyContainer.innerHTML += '<p>Ошибка загрузки</p>';
          });
        } else {
          childInfo.style.display = 'none';
        }
      };

      // Update calendar
      const updateCalendar = () => {
        const daysGrid = document.getElementById('days-grid');
        daysGrid.innerHTML = '';
        const weekDays = ['ПН', 'ВТ', 'СР', 'ЧТ', 'ПТ', 'СБ', 'ВС'];
        const weekStart = getMonday(currentWeekStart);
        document.getElementById('week-date').textContent = `${weekStart.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' })} – ${new Date(weekStart.getTime() + 6 * 24 * 60 * 60 * 1000).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' })}`;

        for (let i = 0; i < 7; i++) {
          const day = new Date(weekStart.getTime() + i * 24 * 60 * 60 * 1000);
          const dateStr = formatDate(day);
          const isActive = dateStr === selectedDate;
          const dayDiv = document.createElement('div');
          dayDiv.className = `day ${isActive ? 'active' : ''}`;
          dayDiv.setAttribute('data-date', dateStr);
          dayDiv.innerHTML = `
            <div class="day__name">${weekDays[i]}</div>
            <div class="day__date">${day.getDate()}</div>
          `;
          daysGrid.appendChild(dayDiv);
        }

        document.querySelectorAll('.day').forEach(day => {
          day.addEventListener('click', () => {
            document.querySelectorAll('.day').forEach(d => d.classList.remove('active'));
            day.classList.add('active');
            selectedDate = day.getAttribute('data-date');
            updateSlots(selectedDate);
            trackEvent('select_date', { date: selectedDate });
          });
        });
      };

      // Update slots
      const updateSlots = (date) => {
        const slotsList = document.querySelector('.slots-list');
        const slotsTitle = document.getElementById('slots-title');
        const dateObj = new Date(date);
        slotsTitle.textContent = `Свободные слоты на ${dateObj.toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' })}`;
        
        const weekStart = formatDate(getMonday(dateObj));
        const weekEnd = formatDate(new Date(getMonday(dateObj).getTime() + 6 * 24 * 60 * 60 * 1000));
        const payload = {
          action: 'slots',
          initData: tg.initData,
          user_id,
          username,
          first_name,
          from: weekStart,
          to: weekEnd
        };
        fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        }).then(response => response.json()).then(data => {
          slotsList.innerHTML = `<div class="section-title">${slotsTitle.textContent}</div>`;
          if (data.success && data.slots) {
            slots = data.slots;
            const daySlots = slots.filter(slot => slot.date === date);
            if (daySlots.length === 0) {
              slotsList.innerHTML += '<p>Нет доступных слотов</p>';
            } else {
              daySlots.forEach(slot => {
                const trainer = trainers.find(t => t.trainer_id === slot.trainer_id);
                const slotCard = document.createElement('div');
                slotCard.className = 'slot-card';
                slotCard.setAttribute('data-slot-id', slot.slot_id);
                slotCard.innerHTML = `
                  <div class="slot-card__info">
                    <div class="slot-card__time">${slot.time}</div>
                    <div class="slot-card__details">Тренер: ${trainer ? trainer.name : 'Неизвестно'} | Свободно: <span class="slot-availability">${slot.capacity - slot.booked}/${slot.capacity}</span></div>
                  </div>
                  <div class="slot-card__action">
                    <button class="btn" data-action="register" ${slot.booked >= slot.capacity ? 'disabled' : ''}>Записаться</button>
                  </div>
                `;
                slotsList.appendChild(slotCard);
              });
            }

            document.querySelectorAll('[data-action="register"]').forEach(btn => {
              btn.addEventListener('click', () => {
                const slotCard = btn.closest('.slot-card');
                const slot_id = slotCard.getAttribute('data-slot-id');
                if (!selectedChildId) {
                  alert('Выберите ребенка для записи');
                  return;
                }
                const balance = balances.find(b => b.child_id === selectedChildId);
                if (!balance || balance.remaining <= 0) {
                  alert('У ребенка недостаточно занятий');
                  return;
                }
                const response_id = generateUUID();
                const payload = {
                  action: 'book',
                  initData: tg.initData,
                  user_id,
                  username,
                  first_name,
                  slot_id,
                  child_id: selectedChildId,
                  response_id
                };
                fetch(API_URL, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload),
                  mode: 'no-cors'
                }).then(() => {
                  console.log('Booking request sent');
                  alert('Запись успешна!');
                  trackEvent('book_slot', { slot_id, child_id: selectedChildId, response_id });
                  bootstrap(); // Refresh data
                }).catch(error => {
                  console.error('Error booking slot:', error);
                  alert('Ошибка при записи');
                });
              });
            });
          } else {
            slotsList.innerHTML += '<p>Нет доступных слотов</p>';
          }
        }).catch(error => {
          console.error('Error updating slots:', error);
          slotsList.innerHTML += '<p>Ошибка загрузки</p>';
        });
      };

      // Bootstrap data
      const bootstrap = () => {
        const payload = {
          action: 'bootstrap',
          initData: tg.initData,
          user_id,
          username,
          first_name
        };
        fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        }).then(response => response.json()).then(data => {
          if (data.success) {
            children = data.children || [];
            balances = data.balances || [];
            trainers = data.trainers || [];
            
            const trainersGrid = document.getElementById('trainers-grid');
            trainersGrid.innerHTML = '';
            trainers.forEach(trainer => {
              const trainerCard = document.createElement('div');
              trainerCard.className = 'trainer-card';
              trainerCard.innerHTML = `
                <div class="trainer-card__avatar">
                  <img src="${trainer.avatar_url}" alt="${trainer.name}">
                </div>
                <div class="trainer-card__name">${trainer.name}</div>
                <div class="trainer-card__speciality">${trainer.speciality}</div>
                <a href="#" class="trainer-card__contact-btn">Написать</a>
              `;
              trainersGrid.appendChild(trainerCard);
            });

            updateChildSelectors();
            updateCalendar();
            updateSlots(selectedDate);
            trackEvent('bootstrap');
          }
        }).catch(error => {
          console.error('Bootstrap error:', error);
          alert('Ошибка загрузки данных');
        });
      };

      // Add child
      document.getElementById('add-child').addEventListener('click', () => {
        const telegram = document.getElementById('parent-telegram').value.trim();
        const name = document.getElementById('child-name').value.trim();
        const birthdate = document.getElementById('child-birthdate').value;
        if (!telegram || !telegram.startsWith('@')) {
          alert('Введите корректный Telegram-ник (например, @username)');
          return;
        }
        if (!name || !birthdate) {
          alert('Введите имя ребенка и дату рождения');
          return;
        }
        const response_id = generateUUID();
        const payload = {
          action: 'register_parent',
          initData: tg.initData,
          user_id,
          username,
          first_name,
          parent: { full_name: first_name || 'Пользователь', telegram },
          children: [{ child_name: name, birthdate }],
          response_id
        };
        fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          mode: 'no-cors'
        }).then(() => {
          console.log('Add child request sent');
          alert('Ребенок добавлен! Мы свяжемся через Telegram.');
          document.getElementById('parent-telegram').value = '';
          document.getElementById('child-name').value = '';
          document.getElementById('child-birthdate').value = '';
          trackEvent('add_child', { telegram, child_name: name, birthdate, response_id });
          bootstrap(); // Refresh data
        }).catch(error => {
          console.error('Error adding child:', error);
          alert('Ошибка при добавлении ребенка');
        });
      });

      // Child selection
      document.getElementById('child-select-profile').addEventListener('change', (e) => {
        selectedChildId = e.target.value;
        document.getElementById('child-select-schedule').value = selectedChildId;
        updateChildInfo(selectedChildId);
        trackEvent('select_child', { child_id: selectedChildId });
      });

      document.getElementById('child-select-schedule').addEventListener('change', (e) => {
        selectedChildId = e.target.value;
        document.getElementById('child-select-profile').value = selectedChildId;
        updateChildInfo(selectedChildId);
        trackEvent('select_child', { child_id: selectedChildId });
      });

      // Tabs logic
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(item => item.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));
          tab.classList.add('active');
          const contentId = tab.getAttribute('data-tab');
          document.getElementById(contentId).classList.add('active');
          trackEvent('tab_click', { tab: contentId });
        });
      });

      // Week navigation
      document.getElementById('prev-week').addEventListener('click', () => {
        currentWeekStart.setDate(currentWeekStart.getDate() - 7);
        updateCalendar();
        updateSlots(selectedDate);
        trackEvent('week_nav', { direction: 'prev' });
      });

      document.getElementById('next-week').addEventListener('click', () => {
        currentWeekStart.setDate(currentWeekStart.getDate() + 7);
        updateCalendar();
        updateSlots(selectedDate);
        trackEvent('week_nav', { direction: 'next' });
      });

      // Initialize
      trackEvent('webapp_open');
      bootstrap();
    });
  </script>
</body>
</html>
