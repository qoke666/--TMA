<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Детская школа карате</title>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+JP:wght@400;500;700&display=swap');

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: #1F2937;
      color: #F3F4F6;
      overflow-y: auto;
      position: relative;
    }

    #tsparticles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      pointer-events: none;
    }

    a { text-decoration: none; }
    ul { list-style: none; margin: 0; padding: 0; }

    .menu-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 16px;
      background: rgba(31, 41, 55, 0.9);
      backdrop-filter: blur(8px);
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .address {
      font-family: 'Noto Sans JP', sans-serif;
      font-size: 16px;
      font-weight: 500;
      color: #F3F4F6;
      letter-spacing: 1px;
      transition: color 0.3s ease;
    }

    .address:hover { color: #14B8A6; }

    .social-links {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .social-title {
      font-size: 12px;
      font-weight: 500;
      color: #6B7280;
    }

    .social-link {
      color: #14B8A6;
      font-size: 16px;
      transition: color 0.3s ease, transform 0.3s ease;
    }

    .social-link:hover {
      color: #F28C38;
      transform: scale(1.1);
    }

    .menu {
      display: flex;
      justify-content: center;
      background: rgba(31, 41, 55, 0.9);
      backdrop-filter: blur(8px);
      padding: 6px 0;
      position: sticky;
      top: 48px;
      z-index: 10;
    }

    .menu ul {
      display: inline-flex;
      gap: 10px;
      padding: 0 16px;
      overflow-x: auto;
      white-space: nowrap;
      scroll-behavior: smooth;
      touch-action: pan-x;
      -webkit-overflow-scrolling: touch;
    }

    .menu ul::-webkit-scrollbar { display: none; }

    .menu-item {
      padding: 6px 12px;
      border-radius: 6px;
      font-family: 'Noto Sans JP', sans-serif;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      color: #6B7280;
      transition: background 0.3s, color 0.3s, transform 0.3s;
    }

    .menu-item.active,
    .menu-item:hover {
      background: #14B8A6;
      color: #F3F4F6;
      transform: scale(1.05);
    }

    .section {
      display: none;
      padding: 8px 16px;
      box-sizing: border-box;
      min-height: 100px;
    }

    .section.active { display: block; opacity: 1; }

    .section-title {
      font-family: 'Noto Sans JP', sans-serif;
      font-size: 24px;
      font-weight: 700;
      margin: 8px 0;
      color: #14B8A6;
      text-align: center;
      position: relative;
    }

    .section-title::before {
      content: '空手';
      font-size: 12px;
      color: #F3F4F6;
      opacity: 0.3;
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
    }

    .card {
      background: linear-gradient(135deg, rgba(31, 41, 55, 0.5), rgba(55, 65, 81, 0.3));
      backdrop-filter: blur(8px);
      border: 1px solid rgba(20, 184, 166, 0.3);
      border-radius: 12px;
      color: #6B7280;
      transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
      position: relative;
      overflow: hidden;
      padding: 12px;
    }

    .card:hover {
      transform: scale(1.03);
      box-shadow: 0 6px 16px rgba(20, 184, 166, 0.4);
      border-color: rgba(20, 184, 166, 0.5);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 8px;
    }

    .calendar-day {
      padding: 8px;
      border-radius: 6px;
      text-align: center;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.3s ease, background 0.3s ease;
      background: rgba(243, 244, 246, 0.1);
      border: 1px solid rgba(243, 244, 246, 0.2);
    }

    .calendar-day.available {
      background: #34d399;
      border: none;
      color: #1F2937;
    }

    .calendar-day.limited {
      background: #f59e0b;
      border: none;
      color: #1F2937;
    }

    .calendar-day.full {
      background: #6B7280;
      border: none;
      color: #F3F4F6;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .calendar-day.past {
      background: rgba(243, 244, 246, 0.1);
      color: #6B7280;
      cursor: not-allowed;
    }

    .calendar-day:hover:not(.full):not(.past) {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3);
    }

    .calendar-header {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 12px;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: #6B7280;
    }

    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.7);
      background: linear-gradient(135deg, rgba(31, 41, 55, 0.85), rgba(55, 65, 81, 0.65));
      backdrop-filter: blur(12px);
      border: 1px solid rgba(20, 184, 166, 0.4);
      border-radius: 16px;
      padding: clamp(12px, 3vw, 16px);
      z-index: 9999;
      color: #F3F4F6;
      max-width: 95%;
      min-width: 300px;
      max-height: 98vh;
      overflow-y: auto;
      scroll-behavior: smooth;
      box-sizing: border-box;
      opacity: 0;
      transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.6s ease, box-shadow 0.6s ease;
    }

    .modal.active {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
      box-shadow: 0 20px 48px rgba(20, 184, 166, 0.4);
    }

    body.modal-open {
      overflow: hidden;
    }

    body.modal-open::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 9998;
      opacity: 0;
      transition: opacity 0.6s ease;
    }

    body.modal-open::before { opacity: 1; }

    .modal h3 {
      font-family: 'Noto Sans JP', sans-serif;
      margin: 0 0 10px;
      color: #14B8A6;
      font-size: clamp(16px, 4vw, 18px);
      text-align: center;
    }

    .modal p {
      font-size: clamp(12px, 3.5vw, 13px);
      color: #6B7280;
      margin: 6px 0;
      text-align: center;
    }

    .modal .apply-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
      max-height: calc(98vh - 80px);
      overflow-y: auto;
      scroll-behavior: smooth;
      padding-bottom: 40px;
      scroll-margin-bottom: 40px;
      padding-right: 5px;
      box-sizing: border-box;
    }

    .modal .apply-form::-webkit-scrollbar {
      width: 4px;
    }

    .modal .apply-form::-webkit-scrollbar-thumb {
      background: rgba(20, 184, 166, 0.4);
      border-radius: 2px;
    }

    .modal .apply-form::-webkit-scrollbar-track {
      background: transparent;
    }

    .modal .apply-form label {
      font-size: clamp(12px, 3.5vw, 13px);
      color: #6B7280;
    }

    .modal .apply-form input,
    .modal .apply-form select,
    .modal .apply-form textarea {
      padding: 5px;
      border: 1px solid #4B5563;
      border-radius: 5px;
      background: #374151;
      color: #F3F4F6;
      font-family: 'Inter', sans-serif;
      font-size: clamp(12px, 3.5vw, 13px);
      box-sizing: border-box;
      width: 100%;
    }

    .modal .apply-form select {
      appearance: none;
      background-image: url('data:image/svg+xml;utf8,<svg fill="%236B7280" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 5px center;
      background-size: 12px;
    }

    .modal .apply-form textarea {
      resize: vertical;
      min-height: 60px;
    }

    .modal .apply-form button {
      padding: 5px 12px;
      background: #14B8A6;
      color: #F3F4F6;
      border: none;
      border-radius: 5px;
      font-family: 'Noto Sans JP', sans-serif;
      font-weight: 600;
      font-size: clamp(12px, 3.5vw, 13px);
      cursor: pointer;
      transition: background 0.3s ease, transform 0.3s ease;
    }

    .modal .apply-form button:hover {
      background: #F28C38;
      transform: scale(1.05);
    }

    .modal .close-button {
      padding: 5px 12px;
      background: #4B5563;
      color: #F3F4F6;
      border: 1px solid #6B7280;
      border-radius: 5px;
      font-weight: 600;
      font-size: clamp(12px, 3.5vw, 13px);
      margin-top: 5px;
      transition: background 0.3s ease, transform 0.3s ease;
    }

    .modal .close-button:hover {
      background: #6B7280;
      transform: scale(1.05);
    }

    .modal .spinner {
      border: 3px solid rgba(20, 184, 166, 0.2);
      border-top: 3px solid #14B8A6;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin: 12px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 360px) {
      .section-title { font-size: 20px; }
      .modal {
        padding: 10px;
        max-height: 95vh;
        min-width: 280px;
      }
      .modal .apply-form {
        max-height: calc(95vh - 60px);
        gap: 6px;
        padding-bottom: 30px;
        scroll-margin-bottom: 30px;
      }
      .modal h3 { font-size: 14px; }
      .modal p { font-size: 11px; }
      .modal .apply-form input,
      .modal .apply-form select,
      .modal .apply-form textarea,
      .modal .apply-form button,
      .modal .close-button {
        font-size: 11px;
        padding: 4px;
      }
      .address { font-size: 14px; }
    }

    @media (max-width: 320px) {
      .modal {
        padding: 8px;
        max-height: 92vh;
        min-width: 260px;
      }
      .modal .apply-form {
        max-height: calc(92vh - 50px);
        gap: 5px;
        padding-bottom: 25px;
        scroll-margin-bottom: 25px;
      }
    }
  </style>
</head>
<body>
  <div id="tsparticles"></div>
  <div class="menu-top">
    <div class="address">Красноярск, ул. Сакура, 12</div>
    <div class="social-links">
      <span class="social-title">Наши соцсети</span>
      <a href="https://t.me/karate_dojo" class="social-link tg-link" data-social="telegram">
        <i class="fab fa-telegram-plane"></i>
      </a>
      <a href="https://www.instagram.com/karate_dojo" class="social-link" data-social="instagram">
        <i class="fab fa-instagram"></i>
      </a>
    </div>
  </div>

  <nav class="menu">
    <ul>
      <li class="menu-item active" data-section="booking">Запись на занятия</li>
    </ul>
  </nav>

  <main>
    <section id="booking" class="section active">
      <h2 class="section-title">Запись на занятия</h2>
      <div class="card" data-aos="fade-up">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-white" id="booking-calendar-title">Загрузка...</h3>
          <div class="flex space-x-2">
            <button class="prev-month p-2 rounded-full bg-transparent hover:bg-white/10 border border-white/20">
              <i class="fas fa-chevron-left text-white"></i>
            </button>
            <button class="next-month p-2 rounded-full bg-transparent hover:bg-white/10 border border-white/20">
              <i class="fas fa-chevron-right text-white"></i>
            </button>
          </div>
        </div>
        <div class="calendar-header">
          <div>Пн</div>
          <div>Вт</div>
          <div>Ср</div>
          <div>Чт</div>
          <div>Пт</div>
          <div>Сб</div>
          <div>Вс</div>
        </div>
        <div class="calendar-grid" id="booking-calendar-grid"><div class="spinner"></div></div>
        <div class="flex flex-wrap gap-x-4 gap-y-2 mt-4 text-xs text-gray-400">
          <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-emerald-500"></div><span>Свободно</span></div>
          <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-amber-500"></div><span>Мало мест</span></div>
          <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-gray-500"></div><span>Мест нет</span></div>
        </div>
      </div>
      <div class="card" data-aos="fade-up" data-aos-delay="150">
        <h3 class="text-lg font-semibold mb-4 text-white">Расписание групп</h3>
        <div class="space-y-2">
          <div class="flex justify-between items-center p-2 bg-white/5 rounded">
            <span class="text-sm">Младшая (4-6 лет)</span>
            <span class="text-xs text-gray-400">16:00 - 17:00</span>
          </div>
          <div class="flex justify-between items-center p-2 bg-white/5 rounded">
            <span class="text-sm">Средняя (7-10 лет)</span>
            <span class="text-xs text-gray-400">17:00 - 18:00</span>
          </div>
          <div class="flex justify-between items-center p-2 bg-white/5 rounded">
            <span class="text-sm">Старшая (11-14 лет)</span>
            <span class="text-xs text-gray-400">18:00 - 19:00</span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="booking-modal" class="modal">
    <h3>Запись на занятие</h3>
    <p id="modal-date" class="text-gray-400 mb-4"></p>
    <form id="booking-form" class="apply-form" autocomplete="off">
      <input type="hidden" id="selected-date" name="selectedDate">
      <input type="hidden" id="username" name="username">
      <div class="full-form">
        <div><label for="child-name">Имя и фамилия ребенка</label><input type="text" id="child-name" name="childName" required></div>
        <div><label for="child-age">Возраст ребенка</label><input type="number" id="child-age" name="childAge" required></div>
        <div><label for="group-select">Выберите группу</label><select id="group-select" name="selectedGroup" required>
          <option value="Младшая (4-6 лет)">Младшая (4-6 лет)</option>
          <option value="Средняя (7-10 лет)">Средняя (7-10 лет)</option>
          <option value="Старшая (11-14 лет)">Старшая (11-14 лет)</option>
        </select></div>
        <div><label for="time-select">Время занятия</label><select id="time-select" name="selectedTime" required>
          <option value="16:00">16:00 - 17:00</option>
          <option value="17:00">17:00 - 18:00</option>
          <option value="18:00">18:00 - 19:00</option>
        </select></div>
        <div><label for="contact-info">Ваш контакт (Телефон/Telegram)</label><input type="text" id="contact-info" name="contactInfo" required></div>
        <div><label for="comments">Комментарии</label><textarea id="comments" name="comments" rows="2" placeholder="Например, есть ли у ребенка опыт..."></textarea></div>
      </div>
      <div class="simple-form" style="display: none;">
        <div><label for="child-name-simple">Имя и фамилия ребенка</label><input type="text" id="child-name-simple" name="childName" required></div>
        <div><label for="group-select-simple">Выберите группу</label><select id="group-select-simple" name="selectedGroup" required>
          <option value="Младшая (4-6 лет)">Младшая (4-6 лет)</option>
          <option value="Средняя (7-10 лет)">Средняя (7-10 лет)</option>
          <option value="Старшая (11-14 лет)">Старшая (11-14 лет)</option>
        </select></div>
        <div><label for="time-select-simple">Время занятия</label><select id="time-select-simple" name="selectedTime" required>
          <option value="16:00">16:00 - 17:00</option>
          <option value="17:00">17:00 - 18:00</option>
          <option value="18:00">18:00 - 19:00</option>
        </select></div>
      </div>
      <button type="submit" id="submit-booking">Записаться</button>
      <button type="button" class="close-button" id="close-modal-button">Отмена</button>
      <div id="modal-spinner" class="spinner" style="display: none;"></div>
    </form>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.12.0/tsparticles.bundle.min.js"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const WEB_APP_URL = 'YOUR_GOOGLE_APPS_SCRIPT_URL';
      const tg = window.Telegram?.WebApp;
      if (tg) tg.expand();
      const userData = (tg?.initDataUnsafe?.user) ? { id: tg.initDataUnsafe.user.id, username: tg.initDataUnsafe.user.username } : {};
      let currentDate = new Date();
      let bookingsData = {};
      const MAX_SPOTS = 10;
      const LIMITED_SPOTS = 5;

      AOS.init({ duration: 600, once: true, offset: 20 });
      if (typeof tsParticles !== 'undefined') {
        tsParticles.load("tsparticles", { particles: { number: { value: 50 }, color: { value: "#14B8A6" }, opacity: { value: 0.4 }, size: { value: 2 }, move: { enable: true, speed: 0.5 } } });
      }

      async function trackEvent(eventName, additionalData = {}) {
        const payload = { event: eventName, ...userData, timestamp: new Date().toISOString(), additional: additionalData };
        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          mode: 'cors',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);
        return result;
      }

      async function fetchBookings() {
        try {
          const response = await fetch(WEB_APP_URL);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const result = await response.json();
          if (result.status === 'success') {
            bookingsData = result.data;
          } else {
            throw new Error(result.message);
          }
        } catch (error) {
          console.error('Не удалось загрузить записи:', error);
          alert('Ошибка: не удалось загрузить расписание. Попробуйте обновить страницу.');
        } finally {
          updateCalendar();
        }
      }

      async function checkUserExists(username) {
        const response = await fetch(WEB_APP_URL + '?action=checkUser&username=' + encodeURIComponent(username));
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        return result.exists;
      }

      const modal = document.getElementById('booking-modal');
      const bookingForm = document.getElementById('booking-form');
      const modalSpinner = document.getElementById('modal-spinner');
      const submitButton = document.getElementById('submit-booking');
      const fullForm = bookingForm.querySelector('.full-form');
      const simpleForm = bookingForm.querySelector('.simple-form');

      function updateCalendar() {
        const grid = document.getElementById('booking-calendar-grid');
        const title = document.getElementById('booking-calendar-title');
        grid.innerHTML = '';
        const month = currentDate.getMonth();
        const year = currentDate.getFullYear();
        title.textContent = `${currentDate.toLocaleString('ru', { month: 'long' })} ${year}`;
        const firstDayOfMonth = new Date(year, month, 1);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const startDayOfWeek = (firstDayOfMonth.getDay() + 6) % 7;
        const allowedDays = [2, 4, 6]; // Вт, Чт, Сб (0-based: Пн=0, Вт=1, ..., Сб=5, Вс=6)

        for (let i = 0; i < startDayOfWeek; i++) grid.insertAdjacentHTML('beforeend', '<div></div>');

        for (let day = 1; day <= daysInMonth; day++) {
          const dayDate = new Date(year, month, day);
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const dayElement = document.createElement('div');
          dayElement.textContent = day;
          dayElement.classList.add('calendar-day');
          const dateString = dayDate.toLocaleDateString('ru');
          const spotsTaken = bookingsData[dateString] || 0;

          if (dayDate < today || !allowedDays.includes(dayDate.getDay())) {
            dayElement.classList.add('past');
          } else {
            if (spotsTaken >= MAX_SPOTS) {
              dayElement.classList.add('full');
            } else if (spotsTaken >= LIMITED_SPOTS) {
              dayElement.classList.add('limited');
            } else {
              dayElement.classList.add('available');
            }
            dayElement.addEventListener('click', () => openModal(dayDate));
          }
          grid.appendChild(dayElement);
        }
      }

      async function openModal(date) {
        document.getElementById('modal-date').textContent = `на ${date.toLocaleDateString('ru')}`;
        document.getElementById('selected-date').value = date.toLocaleDateString('ru');
        document.getElementById('username').value = userData.username || 'N/A';
        const isReturningUser = userData.username ? await checkUserExists(userData.username) : false;
        fullForm.style.display = isReturningUser ? 'none' : 'block';
        simpleForm.style.display = isReturningUser ? 'block' : 'none';
        modal.classList.add('active');
        document.body.classList.add('modal-open');
      }

      function closeModal() {
        modal.classList.remove('active');
        document.body.classList.remove('modal-open');
        bookingForm.reset();
      }

      document.querySelector('.prev-month').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        updateCalendar();
      });

      document.querySelector('.next-month').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        updateCalendar();
      });

      document.getElementById('close-modal-button').addEventListener('click', closeModal);

      bookingForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        modalSpinner.style.display = 'block';
        submitButton.disabled = true;
        const data = Object.fromEntries(new FormData(bookingForm).entries());
        try {
          await trackEvent('booking_request', data);
          tg?.showPopup({ title: 'Успешно!', message: 'Вы записаны! Мы скоро с вами свяжемся.' });
          closeModal();
          fetchBookings();
        } catch (error) {
          tg?.showPopup({ title: 'Ошибка', message: `Не удалось отправить заявку. ${error.message}` });
        } finally {
          modalSpinner.style.display = 'none';
          submitButton.disabled = false;
        }
      });

      fetchBookings();
      trackEvent('webapp_open');
    });
  </script>
</body>
</html>
