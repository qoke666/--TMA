<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Детская Студия</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --bg-main: #101010; --bg-secondary: #1C1C1C; --text-main: #FFFFFF; --text-secondary: #8E8E93; --accent-blue: #007AFF; --accent-green: #34C759; --accent-red: #FF3B30; --border-color: #2D2D2D; }
    @font-face { font-family: 'Inter'; src: url('https://rsms.me/inter/font-files/Inter-Regular.woff2?v=3.19') format('woff2'); font-weight: 400; }
    @font-face { font-family: 'Inter'; src: url('https://rsms.me/inter/font-files/Inter-Medium.woff2?v=3.19') format('woff2'); font-weight: 500; }
    @font-face { font-family: 'Inter'; src: url('https://rsms.me/inter/font-files/Inter-SemiBold.woff2?v=3.19') format('woff2'); font-weight: 600; }
    body { font-family: 'Inter', -apple-system, sans-serif; margin: 0; background-color: var(--bg-main); color: var(--text-main); padding: 16px; -webkit-font-smoothing: antialiased; }
    .container { max-width: 800px; margin: 0 auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .header__logo svg { width: 40px; height: 40px; }
    .promo { background-color: var(--bg-secondary); border-radius: 16px; padding: 24px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; gap: 20px; }
    .promo__text { flex: 1; }
    .promo__title { font-size: 24px; font-weight: 700; margin: 0 0 8px 0; }
    .promo__subtitle { font-size: 16px; color: var(--text-secondary); margin: 0; }
    .promo__image img { width: 100px; height: 100px; }
    .tabs { display: flex; gap: 8px; margin-bottom: 24px; }
    .tab { padding: 10px 16px; border: 1px solid var(--border-color); border-radius: 20px; font-weight: 500; }
    .tab.active { background-color: var(--accent-blue); border-color: var(--accent-blue); }
    .tab-content.hidden { display: none; }
    .form-container { background-color: var(--bg-secondary); border-radius: 16px; padding: 24px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px; color: var(--text-secondary); }
    .form-group input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-main); color: var(--text-main); font-size: 16px; box-sizing: border-box; }
    .form-title { font-size: 20px; font-weight: 600; margin-bottom: 20px; }
    .submit-btn { width: 100%; padding: 14px; border: none; border-radius: 8px; background-color: var(--accent-blue); color: var(--text-main); font-size: 16px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
    .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>

<body>
  <div class="container">
    <header class="header">
      <div class="header__logo">
        <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="20" cy="20" r="20" fill="white"/><path d="M20 31.6667C26.4435 31.6667 31.6667 26.4435 31.6667 20C31.6667 13.5565 26.4435 8.33334 20 8.33334C13.5565 8.33334 8.33337 13.5565 8.33337 20C8.33337 26.4435 13.5565 31.6667 20 31.6667Z" fill="#007AFF"/></svg>
      </div>
    </header>

    <main>
      <section class="promo">
        <div class="promo__text">
          <h1 class="promo__title">Детская Студия</h1>
          <p class="promo__subtitle">Зарегистрируйте вашего ребенка, чтобы начать запись на занятия.</p>
        </div>
        <div class="promo__image">
          <img src="https://em-content.zobj.net/source/apple/354/person-cartwheeling_1f938.png" alt="Гимнастика">
        </div>
      </section>

      <nav class="tabs">
        <div class="tab active">Профиль</div>
      </nav>

      <div class="tab-content" id="profile-tab">
        <div class="form-container">
            <h2 class="form-title">Регистрация</h2>
            <form id="registration-form">
                <div class="form-group">
                    <label for="parent-name">Ваше Имя</label>
                    <input type="text" id="parent-name" name="parent_name" required>
                </div>
                <div class="form-group">
                    <label for="parent-phone">Ваш Телефон</label>
                    <input type="tel" id="parent-phone" name="parent_phone" required>
                </div>
                 <hr style="border-color: var(--border-color); margin: 24px 0;">
                <div class="form-group">
                    <label for="child-name">Имя Ребенка</label>
                    <input type="text" id="child-name" name="child_name" required>
                </div>
                <div class="form-group">
                    <label for="child-dob">Дата Рождения Ребенка</label>
                    <input type="date" id="child-dob" name="child_dob" required>
                </div>
                <button type="submit" class="submit-btn" id="submit-button">Зарегистрировать</button>
            </form>
        </div>
      </div>
    </main>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const tg = window.Telegram.WebApp;
      tg.expand();

      const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwdVdDFU-_w7VK_t-u0tTNbnm4YwhTspaBKUuq6JwUOlAqKiFLFPcQ_W1My1pTNKRl-7A/exec'; // ⚠️ PASTE YOUR DEPLOYED URL HER

      // This is the proven apiCall function from your working example
      function apiCall(event, additional) {
        const user = tg.initDataUnsafe?.user || {};
        const data = {
          event: event,
          initData: tg.initData,
          user_id: user.id || 0,
          username: user.username || '',
          first_name: user.first_name || '',
          last_name: user.last_name || '',
          timestamp: new Date().toISOString(),
          url: window.location.href,
          userAgent: navigator.userAgent,
          additional: additional || {}
        };

        const btn = document.getElementById('submit-button');
        btn.disabled = true;
        btn.textContent = 'Отправка...';

        return fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
          if (result.status === 'ok') {
            tg.showPopup({
                title: 'Успех!',
                message: 'Ребенок успешно зарегистрирован.',
                buttons: [{ type: 'ok', text: 'Закрыть' }]
            }, () => tg.close());
          } else {
            tg.showAlert(result.message || 'Произошла ошибка при регистрации.');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          tg.showAlert('Не удалось связаться с сервером. Попробуйте позже.');
        })
        .finally(() => {
            btn.disabled = false;
            btn.textContent = 'Зарегистрировать';
        });
      }

      // Handle form submission
      const form = document.getElementById('registration-form');
      form.addEventListener('submit', function(event) {
        event.preventDefault();
        
        const formData = new FormData(form);
        const additionalData = {};
        for (let [key, value] of formData.entries()) {
          additionalData[key] = value;
        }

        apiCall('register_child', additionalData);
      });
    });
  </script>
</body>
</html>

