<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Расписание Карате</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background-color: #f8f9fa; padding: 20px; }
        .container { max-width: 600px; margin: auto; }
        .schedule { margin-top: 20px; }
        .child-card { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Расписание занятий по карате</h1>
        
        <!-- Расписание (статическое, можно динамизировать) -->
        <div class="schedule card p-3 mb-4">
            <h5>Расписание:</h5>
            <ul class="list-group">
                <li class="list-group-item">Понедельник: 18:00 - 19:30</li>
                <li class="list-group-item">Среда: 18:00 - 19:30</li>
                <li class="list-group-item">Пятница: 17:00 - 18:30</li>
            </ul>
        </div>
        
        <!-- Регистрация и просмотр -->
        <div id="registerSection" class="card p-3 mb-4">
            <h5>Зарегистрировать ребенка</h5>
            <input type="text" id="childName" class="form-control mb-2" placeholder="Имя ребенка">
            <button onclick="registerChild()" class="btn btn-primary">Зарегистрировать</button>
        </div>
        
        <div id="remainingSection" class="card p-3">
            <h5>Остатки занятий</h5>
            <div id="childrenContainer">
                <p id="remainingInfo">Загрузка...</p>
            </div>
            <button onclick="loadData()" class="btn btn-secondary mt-2">Обновить</button>
        </div>
    </div>

    <script>
        const webApp = window.Telegram.WebApp;
        try { webApp.ready(); } catch(e){ /* если не в Telegram — игнор */ }
        const user = webApp && webApp.initDataUnsafe ? webApp.initDataUnsafe.user : null;
        const telegramID = user ? user.id : 'test123'; // Для теста, если не в Telegram
        const gasUrl = 'https://script.google.com/macros/s/AKfycbyI17STyEsL6vYDBX1d98YElOk9O7KWTwMUL7DxOulDzSkgPXLASnNCfsA1GvNWfM_fEA/exec'; // Замени на свой URL

        async function registerChild() {
            const childName = document.getElementById('childName').value.trim();
            if (!childName) return alert('Введите имя!');
            
            try {
                // Отправляем как application/x-www-form-urlencoded — это простой запрос без preflight
                const params = new URLSearchParams();
                params.append('action', 'addChild');
                params.append('telegramID', telegramID);
                params.append('childName', childName);
                // не добавляем initialRemaining — оставляем дефолт в скрипте
                
                const response = await fetch(gasUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
                    body: params.toString()
                });
                
                // Попытаемся распарсить JSON
                let result;
                try { result = await response.json(); }
                catch (e) {
                  const txt = await response.text();
                  console.error('Non-JSON response:', txt);
                  return alert('Ошибка сервера: ' + txt);
                }
                
                if (result.success) {
                    alert('Ребенок зарегистрирован!');
                    document.getElementById('childName').value = '';
                    loadData();
                } else {
                    alert(result.message || 'Ошибка');
                }
            } catch (err) {
                console.error(err);
                alert('Ошибка сети или неверный URL Web App. Проверь деплой и права доступа.');
            }
        }

        async function loadData() {
            const container = document.getElementById('childrenContainer');
            container.innerHTML = '<p>Загрузка...</p>';
            try {
                const response = await fetch(`${gasUrl}?action=getData&telegramID=${telegramID}`);
                const data = await response.json();
                
                if (!data.success && !Array.isArray(data.children)) {
                    container.innerHTML = '<p>Ребенок не зарегистрирован. Зарегистрируйте выше.</p>';
                    return;
                }

                const children = data.children || [];
                if (children.length === 0) {
                    container.innerHTML = '<p>Ребенок(и) не зарегистрированы. Зарегистрируйте выше.</p>';
                    return;
                }
                container.innerHTML = children.map(ch => {
                    return `<div class="child-card card p-2">
                                <strong>${escapeHtml(ch.childName)}</strong>
                                <div>Осталось: ${escapeHtml(ch.remaining)}</div>
                            </div>`;
                }).join('');
            } catch (err) {
                console.error(err);
                container.innerHTML = '<p class="text-danger">Ошибка сети при загрузке данных.</p>';
            }
        }

        function escapeHtml(text) {
            if (text === undefined || text === null) return '';
            return String(text)
              .replaceAll('&','&amp;')
              .replaceAll('<','&lt;')
              .replaceAll('>','&gt;')
              .replaceAll('"','&quot;')
              .replaceAll("'",'&#039;');
        }

        // Автозагрузка при старте
        loadData();
    </script>
</body>
</html>
