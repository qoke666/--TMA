<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Карате — расписание и профиль (моб. версия)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      --accent:#2B8CFF;
      --muted:#6c757d;
      --card-bg:#ffffff;
      --page-bg:#f4f7fb;
      --radius:12px;
    }
    html,body{height:100%; margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--page-bg); color:#122; -webkit-font-smoothing:antialiased;}
    /* Topbar */
    .topbar{position:fixed; top:0; left:0; right:0; height:68px; display:flex; align-items:center; gap:12px; padding:10px 14px; backdrop-filter: blur(6px); background: rgba(255,255,255,0.85); box-shadow: 0 6px 18px rgba(20,30,60,0.05); z-index:999;}
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7cc3ff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
    .brand-title{font-weight:700; font-size:15px;}
    .topbar-right{margin-left:auto; font-size:13px; color:var(--muted); display:flex; gap:8px; align-items:center;}
    /* Main app container */
    main.app { max-width:980px; margin:84px auto 84px; padding:14px; }
    .card-soft{background:var(--card-bg); border-radius:var(--radius); padding:14px; box-shadow:0 10px 30px rgba(20,30,60,0.04); margin-bottom:12px;}
    h2,h3{margin:0 0 8px 0;}
    .small-muted{color:var(--muted); font-size:0.92rem;}
    /* schedule blocks */
    .group-time{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:12px; border-radius:10px; background:linear-gradient(180deg,#fff,#fbfdff); border:1px solid rgba(10,20,40,0.03); margin-bottom:8px;}
    .group-title{font-weight:700;}
    .group-hours{color:var(--muted); font-weight:600}
    /* trainer */
    .trainer{display:flex; gap:12px; align-items:center; cursor:pointer;}
    .avatar{width:64px;height:64px;border-radius:10px;background:linear-gradient(135deg,#ffd89b,#ffb199);display:flex;align-items:center;justify-content:center;font-weight:700;color:#222;font-size:20px}
    .address{color:var(--muted); margin-top:6px;}
    /* Profile section */
    .form-control{border-radius:10px;}
    .btn-main{background:var(--accent); color:white; border:0; padding:10px 14px; border-radius:12px; font-weight:700;}
    .btn-secondary{background:#fff;border:1px solid rgba(10,20,40,0.06); padding:8px 12px; border-radius:10px;}
    .child-card{display:flex; justify-content:space-between; align-items:center; padding:10px; border-radius:10px; border:1px solid rgba(10,20,40,0.035); background:linear-gradient(180deg,#fff,#fbfdff); margin-bottom:8px;}
    .child-meta{color:var(--muted); font-size:0.92rem;}
    /* Bottom nav (mobile) */
    .bottom-nav{display:none;}
    /* responsive layout for mobile */
    @media (max-width:768px){
      main.app{margin:92px 12px 92px;}
      .topbar-right{display:none;}
      .brand-title{font-size:14px;}
      .group-time{padding:14px;}
      .avatar{width:56px;height:56px;font-size:18px}
      .btn-main{width:100%;}
      /* bottom nav visible on small screens */
      .bottom-nav{position:fixed; left:8px; right:8px; bottom:10px; display:flex; gap:8px; justify-content:space-between; padding:8px; background:rgba(255,255,255,0.95); border-radius:14px; box-shadow:0 10px 40px rgba(10,20,40,0.08); z-index:1000;}
      .bottom-nav button{flex:1; padding:10px 8px; border-radius:10px; border:0; background:transparent; font-weight:700; color:var(--muted);}
      .bottom-nav button.active{background:linear-gradient(90deg,var(--accent),#6ec3ff); color:#fff;}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">KS</div>
      <div>
        <div class="brand-title">Карате — Студия</div>
        <div class="small-muted" style="font-size:12px">расписание и профиль</div>
      </div>
    </div>
    <div class="topbar-right">
      <div class="small-muted">Апрельская ул., 1</div>
      <div class="small-muted">Красноярск, 660050</div>
    </div>
  </header>

  <main class="app">
    <!-- HOME -->
    <section id="homeSection" class="card-soft" aria-label="Главная">
      <h2>Расписание и тренер</h2>
      <p class="small-muted">Группы по возрасту — выберите удобное время</p>

      <div style="margin-top:12px">
        <div class="group-time">
          <div>
            <div class="group-title">Новые школьники</div>
            <div class="group-hours">17:30 — 18:30</div>
          </div>
        </div>

        <div class="group-time">
          <div>
            <div class="group-title">Дошкольники</div>
            <div class="group-hours">18:30 — 19:30</div>
          </div>
        </div>

        <div class="group-time">
          <div>
            <div class="group-title">Старшая группа</div>
            <div class="group-hours">19:30 — 21:00</div>
          </div>
        </div>
      </div>

      <div style="margin-top:14px" class="card-soft">
        <!-- Trainer clickable -->
        <div class="trainer" role="button" onclick="openTrainerTelegram()" title="Открыть Telegram тренера">
          <div class="avatar">ПШ</div>
          <div>
            <div style="font-weight:700">Павел Шестеров</div>
            <div class="small-muted">Главный тренер • 8 лет опыта</div>
            <div class="address">Апрельская ул., 1, Красноярск, Красноярский край, Россия, 660050</div>
          </div>
        </div>
      </div>

      <div class="card-soft">
        <h3>Как нас найти</h3>
        <p class="small-muted">Проходим через арку, поднимаемся на 2 этаж. Парковка во дворе.</p>
        <!-- карта по адресу -->
        <iframe
          src="https://www.google.com/maps?q=Апрельская+ул.,+1,+Красноярск,+Красноярский+край,+Россия,+660050&z=15&output=embed"
          style="width:100%;height:200px;border:0;border-radius:10px;" loading="lazy"></iframe>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="profileSection" class="card-soft" style="margin-top:12px; display:none;" aria-label="Профиль">
      <h2>Мой профиль</h2>
      <p class="small-muted">Зарегистрируйте ребёнка — остальное показывается автоматически</p>

      <div style="margin-top:10px; display:flex; gap:10px; flex-direction:column;">
        <input id="childNameInput" class="form-control" placeholder="Имя ребёнка" aria-label="Имя ребёнка">
        <div style="display:flex; gap:8px;">
          <button class="btn-main" onclick="registerChild()">Добавить ребёнка</button>
          <button class="btn-secondary" onclick="loadChildren()">Обновить</button>
        </div>
        <div id="childrenList" style="margin-top:10px;">
          <div class="small-muted">Загрузка...</div>
        </div>
      </div>
    </section>

    <!-- SCHEDULE DETAILED (optional) -->
    <section id="scheduleSection" class="card-soft" style="margin-top:12px; display:none;">
      <h2>Подробное расписание</h2>
      <p class="small-muted">Возрастные группы и время</p>

      <div style="margin-top:12px;">
        <div class="group-time"><div><div class="group-title">Новые школьники</div><div class="group-hours">17:30 — 18:30</div></div></div>
        <div class="group-time"><div><div class="group-title">Дошкольники</div><div class="group-hours">18:30 — 19:30</div></div></div>
        <div class="group-time"><div><div class="group-title">Старшая группа</div><div class="group-hours">19:30 — 21:00</div></div></div>
      </div>
    </section>

  </main>

  <!-- Bottom nav for mobile -->
  <div class="bottom-nav" id="bottomNav" role="navigation" aria-label="Навигация">
    <button id="btnHome" class="active" onclick="navigate('home')">Главная</button>
    <button id="btnSchedule" onclick="navigate('schedule')">Расписание</button>
    <button id="btnProfile" onclick="navigate('profile')">Профиль</button>
  </div>

  <script>
    // ========== Настройки (замени gasUrl на свой) ==========
    const gasUrl = 'https://script.google.com/macros/s/AKfycbyI17STyEsL6vYDBX1d98YElOk9O7KWTwMUL7DxOulDzSkgPXLASnNCfsA1GvNWfM_fEA/exec';
    // Тренер: ссылка Telegram -> поменяй на свою (пример: 'https://t.me/username' или 'tg://resolve?domain=username')
    const trainerTelegram = 'https://t.me/anachoretes';

    // Telegram WebApp (если используется)
    const webApp = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    try { webApp && webApp.ready(); } catch(e){}
    const user = webApp && webApp.initDataUnsafe ? webApp.initDataUnsafe.user : null;
    const telegramID = user ? user.id : 'test123';

    // Navigation helpers
    function navigate(page){
      document.getElementById('homeSection').style.display = page === 'home' ? '' : 'none';
      document.getElementById('scheduleSection').style.display = page === 'schedule' ? '' : 'none';
      document.getElementById('profileSection').style.display = page === 'profile' ? '' : 'none';
      // bottom nav active state
      document.querySelectorAll('.bottom-nav button').forEach(b => b.classList.remove('active'));
      if (page === 'home') document.getElementById('btnHome').classList.add('active');
      if (page === 'schedule') document.getElementById('btnSchedule').classList.add('active');
      if (page === 'profile') document.getElementById('btnProfile').classList.add('active');
      // load children on profile
      if (page === 'profile') loadChildren();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    function updateNavVisibility(){
      if (window.innerWidth <= 768){
        document.getElementById('bottomNav').style.display = 'flex';
      } else {
        document.getElementById('bottomNav').style.display = 'none';
      }
    }
    window.addEventListener('resize', updateNavVisibility);
    updateNavVisibility();

    // initial
    navigate('home');

    // ========== Trainer click ==========
    function openTrainerTelegram(){
      window.open(trainerTelegram, '_blank');
    }

    // ========== API: registerChild (form-urlencoded), loadChildren ==========
    async function registerChild(){
      const input = document.getElementById('childNameInput');
      const name = (input.value || '').trim();
      if (!name) { alert('Введите имя ребёнка'); return; }

      try {
        const params = new URLSearchParams();
        params.append('action','addChild');
        params.append('telegramID', telegramID);
        params.append('childName', name);

        const resp = await fetch(gasUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body: params.toString()
        });

        let result;
        try { result = await resp.json(); }
        catch (e) {
          const txt = await resp.text();
          console.error('Non-JSON response:', txt);
          alert('Ошибка сервера: ' + txt);
          return;
        }

        if (result.success){
          input.value = '';
          await loadChildren();
          showToast('Ребёнок добавлен');
        } else {
          alert(result.message || 'Ошибка при добавлении');
        }
      } catch (err) {
        console.error(err);
        alert('Ошибка сети или неверный URL WebApp. Проверьте деплой и права доступа.');
      }
    }

    async function loadChildren(){
      const list = document.getElementById('childrenList');
      list.innerHTML = '<div class="small-muted">Загрузка...</div>';
      try {
        const resp = await fetch(`${gasUrl}?action=getData&telegramID=${telegramID}`);
        const data = await resp.json();
        const children = Array.isArray(data.children) ? data.children : [];

        if (children.length === 0){
          list.innerHTML = '<div class="small-muted">Ребёнок(и) не зарегистрированы.</div>';
          return;
        }

        list.innerHTML = children.map(ch => {
          return `<div class="child-card">
                    <div>
                      <div style="font-weight:700">${escapeHtml(ch.childName)}</div>
                      <div class="child-meta">Осталось занятий: <strong>${Number(ch.remaining)}</strong></div>
                    </div>
                    <div style="min-width:80px; text-align:right">
                      <button class="btn-secondary" onclick="alert('Если нужно изменить остаток — обратитесь к тренеру')">править</button>
                    </div>
                  </div>`;
        }).join('');
      } catch (err) {
        console.error(err);
        list.innerHTML = '<div class="small text-danger">Ошибка загрузки. Проверьте URL и права WebApp.</div>';
      }
    }

    function escapeHtml(text){
      if (text === undefined || text === null) return '';
      return String(text).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');
    }

    // tiny toast
    function showToast(msg){
      const el = document.createElement('div');
      el.style.position='fixed'; el.style.left='50%'; el.style.transform='translateX(-50%)'; el.style.bottom='110px';
      el.style.background='var(--accent)'; el.style.color='#fff'; el.style.padding='10px 14px'; el.style.borderRadius='10px'; el.style.boxShadow='0 8px 30px rgba(20,40,80,0.12)'; el.style.fontWeight=700; el.style.zIndex=2000;
      el.innerText = msg;
      document.body.appendChild(el);
      setTimeout(()=> el.style.opacity='0',1400);
      setTimeout(()=> el.remove(),2000);
    }

    // Accessibility: allow Enter key to submit child name
    document.addEventListener('keydown', function(e){
      const input = document.getElementById('childNameInput');
      if (document.activeElement === input && e.key === 'Enter') registerChild();
    });
  </script>
</body>
</html>
