<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Карате — расписание и профиль</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --accent: #007bff;
      --accent-light: #e6f2ff;
      --muted: #6c757d;
      --card-bg: #ffffff;
      --page-bg: #f8f9fa;
      --border-color: #dee2e6;
      --text-dark: #212529;
      --text-light: #495057;
      --shadow: 0 8px 25px rgba(0, 0, 0, 0.05);
    }
    
    html, body {
      height: 100%;
      margin: 0;
      overflow-x: hidden;
    }
    
    body {
      background: var(--page-bg);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      color: var(--text-dark);
      padding: 16px;
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
    }
    
    .app {
      max-width: 800px;
      margin: 0 auto;
    }

    /* Navigation Menu */
    .menu {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      padding-bottom: 8px;
      overflow-x: auto;
      scrollbar-width: none;
    }
    .menu::-webkit-scrollbar { display: none; }
    
    .menu .nav-item button {
      background: transparent;
      border: 1px solid var(--border-color);
      padding: 10px 20px;
      border-radius: 25px;
      color: var(--text-light);
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .menu .nav-item button.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.2);
    }
    .menu .nav-item button:hover:not(.active) {
      background: var(--accent-light);
      border-color: var(--accent);
      color: var(--accent);
    }
    
    /* Cards */
    .card-soft {
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid #f0f0f0;
    }

    h2, h3, h5 {
        font-weight: 700;
        color: var(--text-dark);
    }
    
    .section-title { margin-bottom: 8px; font-size: 22px; }
    .section-subtitle { color: var(--muted); margin-bottom: 20px; font-size: 15px; }

    /* Back Button */
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: transparent;
      border: none;
      font-weight: 600;
      font-size: 16px;
      color: var(--accent);
      margin-bottom: 16px;
      cursor: pointer;
    }
    
    /* Schedule Calendar (7 days from today) */
    .calendar-week {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      margin-top: 16px;
    }
    .calendar-day {
      text-align: center;
      padding: 12px 8px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.18s ease-in-out;
      border: 1px solid transparent;
      background: linear-gradient(180deg,#fff,#fbfdff);
    }
    .calendar-day .day-name { font-size: 12px; color: var(--muted); font-weight: 600; }
    .calendar-day .day-number { font-size: 16px; font-weight: 700; color: var(--text-dark); margin-top:6px; }
    .calendar-day.has-events {
      background: linear-gradient(180deg,var(--accent-light), #fff);
      border: 2px solid var(--accent);
      color: var(--accent);
      box-shadow: 0 6px 18px rgba(0,123,255,0.08);
    }
    .calendar-day.today {
      box-shadow: 0 6px 18px rgba(0,0,0,0.04);
      transform: translateY(-2px);
    }
    .calendar-day:hover { transform: translateY(-3px); }

    .group-time {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px;
      border-radius: 12px;
      background: var(--page-bg);
      border: 1px solid var(--border-color);
      margin-bottom: 12px;
    }
    .group-title { font-weight: 600; font-size: 17px; }
    .group-hours { color: var(--muted); font-weight: 500; font-size: 15px; }

    /* Trainer Card */
    .trainer-card {
        display: flex;
        align-items: center;
        gap: 20px;
        text-decoration: none;
        color: inherit;
        transition: transform 0.2s ease;
    }
    .trainer-card:hover {
        transform: scale(1.02);
    }
    .trainer-card .avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #007bff, #0056b3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #fff;
        font-size: 24px;
        flex-shrink: 0;
    }
    .trainer-info .name { font-size: 18px; font-weight: 700; }
    .trainer-info .title { color: var(--muted); font-size: 14px; }
    .trainer-arrow {
        margin-left: auto;
        font-size: 24px;
        color: var(--accent);
    }

    /* Profile Section */
    #profileSection .form-control {
      border-radius: 12px;
      font-size: 16px;
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      background-color: var(--page-bg);
    }
    #profileSection .form-control:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px var(--accent-light);
    }
    .profile-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
    }
    .profile-header .avatar {
      width: 60px; height: 60px; border-radius: 50%;
      background: linear-gradient(135deg, #6f42c1, #a985d7);
      color: white; font-size: 24px; font-weight: 700;
      display: flex; align-items: center; justify-content: center;
    }
    .child-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 15px;
        padding: 16px;
        border-radius: 15px;
        background: linear-gradient(135deg, #f8f9fa, #ffffff);
        border: 1px solid var(--border-color);
        margin-bottom: 12px;
    }
    .child-info .name { font-weight: 600; font-size: 18px; }
    .child-info .lessons {
        font-size: 14px; color: var(--muted);
    }
    .child-info .lessons strong { color: var(--accent); font-size: 16px; }
    .extra-badge {
        display: inline-block;
        background: #e6f7ff; color: #006fa6;
        padding: 4px 10px; border-radius: 8px;
        font-weight: 600; font-size: 13px;
        margin-left: 8px;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
      animation: fadeIn 0.18s;
    }
    .modal-content {
      background-color: #fff;
      margin: 12% auto;
      padding: 18px;
      border: 0;
      border-radius: 16px;
      max-width: 520px;
      width: 92%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      animation: slideIn 0.18s;
    }
    .close-button {
      color: #aaa;
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    .close-button:hover, .close-button:focus { color: #000; }

    /* Responsive */
    @media (max-width: 768px) {
      body { padding: 12px; }
      .card-soft { padding: 18px; margin-bottom: 16px; }
      .calendar-week { grid-template-columns: repeat(4, 1fr); gap: 8px; }
      .calendar-day { padding: 10px 6px; }
      .calendar-day .day-number { font-size: 15px; }
    }
  </style>
</head>
<body>
  <main class="app">
    <nav class="menu" aria-label="Главная навигация">
      <div class="nav-item"><button id="nav-home" class="active" onclick="showSection('home')">Главная</button></div>
      <div class="nav-item"><button id="nav-schedule" onclick="showSection('schedule')">Расписание</button></div>
      <div class="nav-item"><button id="nav-profile" onclick="showSection('profile')">Профиль</button></div>
    </nav>
    
    <!-- HOME -->
    <section id="homeSection">
      <div class="card-soft" id="todayScheduleCard">
        <h2 class="section-title" id="todayTitle">Расписание на сегодня</h2>
        <p class="section-subtitle" id="todaySubtitle">—</p>

        <!-- week strip: 7 days starting today -->
        <div id="weekStrip" class="calendar-week" aria-hidden="false" role="list"></div>

        <!-- today's events (detailed) -->
        <div id="todayEvents" style="margin-top:18px" aria-live="polite"></div>
      </div>

      <a id="trainerLink" href="https://t.me/your_telegram_username" target="_blank" class="card-soft trainer-card" aria-label="Открыть Telegram тренера">
          <div class="avatar">ПШ</div>
          <div class="trainer-info">
              <div class="name">Павел Шестеров</div>
              <div class="title">Главный тренер, 6 дан, опыт 12 лет</div>
          </div>
          <div class="trainer-arrow" aria-hidden="true">&rarr;</div>
      </a>

      <div class="card-soft">
        <h5 class="section-title">Как нас найти</h5>
        <p class="address" style="color: var(--muted); font-size: 15px;">Апрельская ул., 1, Красноярск. Проходим через арку, студия на 2 этаже.</p>
        <iframe
          src="https://www.google.com/maps?q=56.0105,92.8525&z=15&output=embed"
          style="width:100%;height:150px;border:0;border-radius:16px;margin-top:12px;"
          loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </section>

    <!-- SCHEDULE (fallback, kept for compatibility) -->
    <section id="scheduleSection" style="display:none;">
      <div class="card-soft">
        <button class="back-btn" onclick="showSection('home')">&larr; Назад</button>
        <h2 class="section-title">Расписание на неделю</h2>
        <p class="section-subtitle">Выберите день, чтобы посмотреть время занятий.</p>
        
        <div id="scheduleWeekGrid" class="calendar-week" aria-hidden="true"></div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="profileSection" style="display:none;">
      <div class="card-soft">
        <button class="back-btn" onclick="showSection('home')">&larr; Назад</button>
        <div class="profile-header">
            <div class="avatar" id="user-initials"></div>
            <div>
                 <h2 class="section-title" style="margin-bottom: 0;">Мой профиль</h2>
                 <p class="section-subtitle" style="margin-bottom: 0;">Управление данными и занятиями</p>
            </div>
        </div>
        
        <div class="row g-4 mt-2">
            <div class="col-md-6">
                <h5 style="font-weight:600; margin-bottom: 16px;">Добавить ребёнка</h5>
                <div class="mb-3">
                    <input id="childNameInput" class="form-control" placeholder="Имя и фамилия ребёнка">
                </div>
                <button class="btn btn-primary w-100" onclick="registerChild()" style="padding:12px;border-radius:12px;font-weight:600">Зарегистрировать</button>
            </div>

            <div class="col-md-6">
                <h5 style="font-weight:600; margin-bottom: 16px;">Мои дети</h5>
                <div id="childrenList">
                  <div class="small text-muted">Загрузка...</div>
                </div>
            </div>
        </div>
      </div>
    </section>
  </main>
  
  <!-- Schedule Modal -->
  <div id="scheduleModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content" role="document">
      <span class="close-button" onclick="closeScheduleModal()" aria-label="Закрыть">&times;</span>
      <h3 id="modal-title" style="margin-bottom: 12px;">Расписание</h3>
      <div id="modal-body" class="d-flex flex-column gap-3"></div>
    </div>
  </div>

  <script>
    // === Настройки API (оставил ваш) ===
    const gasUrl = 'https://script.google.com/macros/s/AKfycbyI17STyEsL6vYDBX1d98YElOk9O7KWTwMUL7DxOulDzSkgPXLASnNCfsA1GvNWfM_fEA/exec';

    // Telegram WebApp init (необязательно)
    const webApp = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    try { webApp && webApp.ready(); } catch (e) {}
    const user = webApp && webApp.initDataUnsafe ? webApp.initDataUnsafe.user : { first_name: 'User', last_name: ''};
    const telegramID = user && user.id ? user.id : 'test123';

    // Schedule cache from API
    let scheduleCache = [];

    // Russian weekday names short/long
    const RU_WEEKDAYS_SHORT = ['ВС','ПН','ВТ','СР','ЧТ','ПТ','СБ'];
    const RU_WEEKDAYS_LONG = ['Воскресенье','Понедельник','Вторник','Среда','Четверг','Пятница','Суббота'];

    // Load schedule from API (no telegramID)
    async function loadSchedule() {
      try {
        const resp = await fetch(`${gasUrl}?action=getSchedule`);
        const data = await resp.json();
        if (data.success) {
          scheduleCache = data.schedule || [];
        } else {
          console.error('Failed to load schedule');
          scheduleCache = [];
        }
      } catch (err) {
        console.error(err);
        scheduleCache = [];
      }
    }

    // Get events for a specific weekday
    function getEventsForWeekday(wd) {
      return scheduleCache.filter(ev => Number(ev.weekday) === wd) || [];
    }

    // === Navigation ===
    function setActiveNav(id) {
      document.querySelectorAll('.menu .nav-item button').forEach(b => b.classList.remove('active'));
      const btn = document.getElementById('nav-' + id);
      if (btn) btn.classList.add('active');
    }
    function showSection(name) {
      document.getElementById('homeSection').style.display = name === 'home' ? '' : 'none';
      document.getElementById('scheduleSection').style.display = name === 'schedule' ? '' : 'none';
      document.getElementById('profileSection').style.display = name === 'profile' ? '' : 'none';
      setActiveNav(name);
      if (name === 'profile') {
        loadChildren();
        const initials = (user.first_name ? user.first_name[0] : '') + (user.last_name ? user.last_name[0] : '');
        document.getElementById('user-initials').textContent = initials || 'U';
      }
    }
    showSection('home');

    // === Build week strip starting from today (7 days) ===
    function buildWeekStrip() {
      const weekStrip = document.getElementById('weekStrip');
      weekStrip.innerHTML = '';
      const today = new Date();
      const days = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date(today);
        d.setDate(today.getDate() + i);
        days.push(d);
      }
      days.forEach((d, idx) => {
        const wd = d.getDay(); // 0..6
        const dayName = RU_WEEKDAYS_SHORT[wd];
        const dayNum = d.getDate();
        const isToday = isSameDate(d, new Date());
        const events = getEventsForWeekday(wd);
        const hasEvents = events.length > 0;
        const el = document.createElement('button');
        el.className = 'calendar-day' + (hasEvents ? ' has-events' : '') + (isToday ? ' today' : '');
        el.setAttribute('type','button');
        el.setAttribute('aria-label', `${RU_WEEKDAYS_LONG[wd]}, ${d.toLocaleDateString('ru-RU')}`);
        el.innerHTML = `<div class="day-name">${dayName}</div><div class="day-number">${dayNum}</div>`;
        el.onclick = () => openScheduleModalForDate(d);
        weekStrip.appendChild(el);
      });
    }

    // Render today's events block (under week strip)
    function renderTodayEvents() {
      const today = new Date();
      const wd = today.getDay();
      const events = getEventsForWeekday(wd);
      const title = document.getElementById('todayTitle');
      const subtitle = document.getElementById('todaySubtitle');
      const todayEvents = document.getElementById('todayEvents');
      title.textContent = 'Расписание на сегодня';
      subtitle.textContent = formatFullDate(today); // e.g., "Понедельник, 15 сентября"
      if (!events || events.length === 0) {
        todayEvents.innerHTML = `<div class="group-time"><div><div class="group-title">На сегодня занятий нет</div><div class="group-hours" style="color:var(--muted)">Отдохните — следующий день занятий появится в расписании</div></div><div></div></div>`;
      } else {
        todayEvents.innerHTML = events.map(ev => `
          <div class="group-time" role="article">
            <div>
              <div class="group-title">${escapeHtml(ev.group || ev.title)}</div>
              <div class="group-hours">${escapeHtml(ev.note || '')}</div>
            </div>
            <div class="group-hours"><strong>${escapeHtml(ev.time)}</strong></div>
          </div>
        `).join('');
      }
    }

    // open modal with schedule for a specific Date object
    function openScheduleModalForDate(dateObj) {
      const modal = document.getElementById('scheduleModal');
      const modalTitle = document.getElementById('modal-title');
      const modalBody = document.getElementById('modal-body');
      const wd = dateObj.getDay();
      const events = getEventsForWeekday(wd);
      modalTitle.textContent = `Расписание на ${RU_WEEKDAYS_LONG[wd]}, ${formatFullDate(dateObj)}`;
      if (events.length === 0) {
        modalBody.innerHTML = '<div class="group-time"><div><div class="group-title">На этот день занятий нет.</div></div></div>';
      } else {
        modalBody.innerHTML = events.map(ev => `
          <div class="group-time">
            <div><div class="group-title">${escapeHtml(ev.group || ev.title)}</div><div class="group-hours" style="color:var(--muted)">${escapeHtml(ev.note || '')}</div></div>
            <div class="group-hours"><strong>${escapeHtml(ev.time)}</strong></div>
          </div>
        `).join('');
      }
      modal.style.display = 'block';
      modal.setAttribute('aria-hidden','false');
    }

    function closeScheduleModal() {
      const modal = document.getElementById('scheduleModal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
    }
    window.onclick = function(event) {
      const modal = document.getElementById('scheduleModal');
      if (event.target == modal) {
        closeScheduleModal();
      }
    }

    // helper: format full date like "Понедельник, 15 сентября"
    function formatFullDate(d) {
      const wd = d.getDay();
      const day = d.getDate();
      const month = d.toLocaleString('ru-RU', { month: 'long' });
      return `${RU_WEEKDAYS_LONG[wd]}, ${day} ${capitalize(month)}`;
    }
    function capitalize(s){ if(!s) return s; return s.charAt(0).toUpperCase() + s.slice(1); }

    function isSameDate(a, b) {
      return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
    }

    // schedule initial render + schedule to rerender at next midnight
    async function renderScheduleAndSetMidnightUpdate() {
      await loadSchedule(); // Load from API
      buildWeekStrip();
      renderTodayEvents();
      // clear previous timer if any
      if (window._midnightTimer) clearTimeout(window._midnightTimer);
      // compute ms until next midnight (local)
      const now = new Date();
      const tomorrow = new Date(now);
      tomorrow.setHours(24,0,2,0); // a tiny offset (2s) after midnight to be safe
      const ms = tomorrow - now;
      window._midnightTimer = setTimeout(() => {
        // on next day: rerender schedule
        renderScheduleAndSetMidnightUpdate();
      }, ms);
    }

    // init schedule
    renderScheduleAndSetMidnightUpdate();

    // === Existing API functions (registerChild, loadChildren) - untouched except children display shows extra ===
    async function registerChild() {
      const nameInput = document.getElementById('childNameInput');
      const childName = (nameInput.value || '').trim();
      if (!childName) { alert('Введите имя ребёнка'); return; }

      try {
        const params = new URLSearchParams();
        params.append('action', 'addChild');
        params.append('telegramID', telegramID);
        params.append('childName', childName);

        const resp = await fetch(gasUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body: params.toString()
        });
        
        const result = await resp.json();

        if (result.success) {
          nameInput.value = '';
          await loadChildren();
          showTinyToast('Ребёнок успешно добавлен!');
        } else {
          alert(result.message || 'Ошибка при добавлении');
        }
      } catch (err) {
        console.error(err);
        alert('Ошибка сети. Проверьте URL WebApp.');
      }
    }

    async function loadChildren() {
      const list = document.getElementById('childrenList');
      list.innerHTML = '<div class="small text-muted">Загрузка...</div>';
      try {
        const resp = await fetch(`${gasUrl}?action=getData&telegramID=${telegramID}`);
        const data = await resp.json();
        const children = (data.children && Array.isArray(data.children)) ? data.children : [];

        if (children.length === 0) {
          list.innerHTML = '<div class="small text-muted">У вас пока нет зарегистрированных детей.</div>';
          return;
        }

        list.innerHTML = children.map(ch => {
          const extra = ch.extra ? Number(ch.extra) : 0;
          const extraHtml = extra > 0 ? `<span class="extra-badge">+${extra} отработок</span>` : '';
          return `<div class="child-card">
                      <div class="child-info">
                          <div class="name">${escapeHtml(ch.childName)}</div>
                          <div class="lessons">Осталось занятий: <strong>${Number(ch.remaining)}</strong> ${extraHtml}</div>
                      </div>
                  </div>`;
        }).join('');
      } catch (err) {
        console.error(err);
        list.innerHTML = '<div class="small text-danger">Ошибка загрузки данных.</div>';
      }
    }

    function escapeHtml(text) {
      if (text === undefined || text === null) return '';
      return String(text).replace(/[&<>"']/g, match => ({
          '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[match]));
    }
    
    function showTinyToast(msg){
      const el = document.createElement('div');
      el.style.position = 'fixed';
      el.style.left = '50%';
      el.style.transform = 'translateX(-50%)';
      el.style.bottom = '20px';
      el.style.padding = '12px 20px';
      el.style.background = 'linear-gradient(135deg, #28a745, #218838)';
      el.style.color = '#fff';
      el.style.borderRadius = '12px';
      el.style.boxShadow = '0 8px 20px rgba(0,0,0,0.15)';
      el.style.fontWeight = 600;
      el.style.fontSize = '14px';
      el.style.zIndex = '2000';
      el.style.opacity = '0';
      el.style.transition = 'opacity 0.3s, bottom 0.3s';
      el.innerText = msg;
      document.body.appendChild(el);
      
      setTimeout(() => {
        el.style.opacity = '1';
        el.style.bottom = '30px';
      }, 10);
      
      setTimeout(() => {
        el.style.opacity = '0';
        el.style.bottom = '20px';
      }, 2700);
      setTimeout(() => el.remove(), 3000);
    }

    // expose close modal globally
    window.closeScheduleModal = closeScheduleModal;

    // provide also schedule page grid (same as week strip) for compatibility
    function renderSchedulePageGrid() {
      const grid = document.getElementById('scheduleWeekGrid');
      grid.innerHTML = '';
      const today = new Date();
      for (let i = 0; i < 7; i++) {
        const d = new Date(today);
        d.setDate(today.getDate() + i);
        const wd = d.getDay();
        const events = getEventsForWeekday(wd);
        const hasEvents = events.length > 0;
        const el = document.createElement('div');
        el.className = 'calendar-day' + (hasEvents ? ' has-events' : '');
        el.innerHTML = `<div class="day-name">${RU_WEEKDAYS_SHORT[wd]}</div><div class="day-number">${d.getDate()}</div>`;
        el.onclick = () => openScheduleModalForDate(d);
        grid.appendChild(el);
      }
    }
    renderSchedulePageGrid();

    // rerender schedule when window regains focus (in case device slept over midnight)
    window.addEventListener('focus', () => {
      renderScheduleAndSetMidnightUpdate();
    });

  </script>
</body>
</html>
