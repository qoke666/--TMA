<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Карате — расписание и профиль</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --accent:#2B8CFF;
      --muted:#6c757d;
      --card-bg: #ffffff;
      --page-bg: #f4f7fb;
    }
    html,body{height:100%;}
    body{
      background:var(--page-bg);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color:#222;
      padding-top: 80px;
    }

    /* Navbar */
    .topbar{
      position: fixed;
      top: 0; left:0; right:0;
      height:72px;
      background:linear-gradient(90deg, rgba(255,255,255,0.85), rgba(255,255,255,0.75));
      backdrop-filter: blur(6px);
      display:flex;
      align-items:center;
      box-shadow: 0 6px 18px rgba(30,40,60,0.06);
      z-index: 1000;
      padding: 0 18px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:700; color:var(--accent);
      font-size:18px;
    }
    .brand .logo{
      width:42px;height:42px;border-radius:10px;
      background:linear-gradient(135deg,var(--accent),#7cc3ff);
      display:flex;align-items:center;justify-content:center;color:white;font-weight:700;
      box-shadow: 0 6px 18px rgba(43,140,255,0.18);
    }

    /* nav menu */
    .menu{
      margin-left:24px;
      display:flex; gap:6px;
    }
    .menu .nav-item button{
      background:transparent; border:0; padding:8px 12px; border-radius:10px;
      color:#0b1a2b; font-weight:600;
    }
    .menu .nav-item button.active{
      background: rgba(43,140,255,0.12); color: var(--accent);
      box-shadow: none;
    }

    /* container */
    .app {
      max-width: 980px;
      margin: 0 auto;
      padding: 18px;
    }

    .card-soft{
      background:var(--card-bg);
      border-radius:14px;
      box-shadow: 0 8px 30px rgba(40,50,80,0.04);
      padding:18px;
    }

    /* schedule */
    .group-time {
      display:flex; justify-content:space-between; align-items:center;
      gap:12px; padding:12px; border-radius:10px;
      transition: transform .18s ease, box-shadow .18s;
      background: linear-gradient(180deg, rgba(250,250,255,1), rgba(247,250,255,1));
      border: 1px solid rgba(20,30,60,0.03);
    }
    .group-time:hover{ transform: translateY(-4px); box-shadow: 0 10px 30px rgba(22,35,62,0.06); }

    .group-title{ font-weight:700; font-size:1.05rem; }
    .group-hours{ color:var(--muted); font-weight:600; }

    /* trainer */
    .trainer{
      display:flex; gap:14px; align-items:center;
    }
    .trainer .avatar{
      width:78px;height:78px;border-radius:12px;
      background:linear-gradient(135deg,#ffd89b,#ffb199);
      display:flex;align-items:center;justify-content:center;font-weight:700;color:#222;
      font-size:20px; box-shadow: 0 8px 26px rgba(255,170,100,0.12);
    }
    .address{ color:var(--muted); font-size:0.95rem; margin-top:8px; }

    /* profile section */
    #profileSection .form-control{ border-radius:10px; }
    .child-card {
      display:flex; justify-content:space-between; align-items:center;
      gap:12px; padding:12px; border-radius:10px; border:1px solid rgba(10,20,40,0.035);
      background: linear-gradient(180deg,#fff,#fbfdff);
    }
    .child-meta { color:var(--muted); font-size:0.9rem; }
    .btn-ghost { background:transparent; border:1px solid rgba(10,20,40,0.06); border-radius:9px; padding:6px 10px; }

    /* responsive tweaks */
    @media (max-width:768px){
      .menu { display:none; }
      body { padding-top:92px; }
      .trainer { flex-direction:row; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo">KS</div>
      <div>
        Карате<br><small style="font-weight:600;color:#1f2b3a;opacity:.6">Студия — расписание и профиль</small>
      </div>
    </div>

    <nav class="menu ms-3">
      <div class="nav-item"><button id="nav-home" class="active" onclick="showSection('home')">Главная</button></div>
      <div class="nav-item"><button id="nav-schedule" onclick="showSection('schedule')">Расписание</button></div>
      <div class="nav-item"><button id="nav-profile" onclick="showSection('profile')">Мой профиль</button></div>
    </nav>

    <div class="ms-auto d-flex align-items-center gap-2">
      <div class="small" style="color:var(--muted)">Адрес:</div>
      <div style="font-weight:700">ул. Спортивная, 12, офис 3</div>
    </div>
  </div>

  <main class="app">
    <!-- HOME -->
    <section id="homeSection" class="mb-4">
      <div class="card-soft mb-4">
        <h2 style="margin-bottom:8px">Расписание сегодня</h2>
        <p class="small" style="color:var(--muted); margin-bottom:12px;">Группы по возрасту — удобное распределение времени занятий</p>

        <div class="row g-3">
          <div class="col-md-4">
            <div class="group-time">
              <div>
                <div class="group-title">Новые школьники</div>
                <div class="group-hours">17:30 — 18:30</div>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="group-time">
              <div>
                <div class="group-title">Дошкольники</div>
                <div class="group-hours">18:30 — 19:30</div>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="group-time">
              <div>
                <div class="group-title">Старшая группа</div>
                <div class="group-hours">19:30 — 21:00</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card-soft mb-4 d-flex gap-3 align-items-center">
        <div class="trainer">
          <div class="avatar">AK</div>
          <div>
            <div style="font-weight:700">Алексей Ковалёв</div>
            <div class="small" style="color:var(--muted)">Главный тренер — 6 дан, опыт 12 лет</div>
            <div class="address">Студия: ул. Спортивная, 12 • Тел: +7 (900) 123-45-67</div>
          </div>
        </div>
        <div class="ms-auto text-end">
          <div class="small-muted" style="color:var(--muted)">Следующий набор</div>
          <div style="font-weight:700">1 октября</div>
        </div>
      </div>

      <div class="card-soft">
        <h5>Как нас найти</h5>
        <p class="address">Проходим через арку, поднимаемся по лестнице — студия на 2 этаже. Рядом — станция метро "Победа", парковка во дворе.</p>
        <iframe
          src="https://www.google.com/maps?q=48.8566,2.3522&z=15&output=embed"
          style="width:100%;height:220px;border:0;border-radius:10px;margin-top:10px;"
          loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </section>

    <!-- SCHEDULE (separate page also) -->
    <section id="scheduleSection" class="mb-4" style="display:none;">
      <div class="card-soft">
        <h3>Полное расписание</h3>
        <p class="small" style="color:var(--muted)">Группы и время занятий</p>

        <div class="row g-3 mt-3">
          <div class="col-12 col-md-6">
            <div class="group-time">
              <div>
                <div class="group-title">Новые школьники</div>
                <div class="group-hours">17:30 — 18:30</div>
                <div class="small" style="color:var(--muted);margin-top:6px">Возраст: 7–10 лет</div>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="group-time">
              <div>
                <div class="group-title">Дошкольники</div>
                <div class="group-hours">18:30 — 19:30</div>
                <div class="small" style="color:var(--muted);margin-top:6px">Возраст: 4–6 лет</div>
              </div>
            </div>
          </div>

          <div class="col-12 mt-3">
            <div class="group-time">
              <div>
                <div class="group-title">Старшая группа</div>
                <div class="group-hours">19:30 — 21:00</div>
                <div class="small" style="color:var(--muted);margin-top:6px">Возраст: 11+ лет</div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- PROFILE -->
    <section id="profileSection" style="display:none;">
      <div class="card-soft mb-3">
        <h3>Мой профиль</h3>
        <p class="small" style="color:var(--muted)">Здесь можно зарегистрировать ребёнка и посмотреть остатки занятий.</p>

        <div class="row g-3 mt-3">
          <div class="col-md-6">
            <div>
              <label class="form-label">Имя ребёнка</label>
              <input id="childNameInput" class="form-control" placeholder="Иван">
            </div>
            <div class="mt-2 d-flex gap-2">
              <button class="btn btn-primary" onclick="registerChild()">Добавить</button>
              <button class="btn btn-outline-secondary" onclick="loadChildren()">Обновить</button>
            </div>
            <div class="small text-muted mt-2">Родителям не нужно вводить количество занятий — только имя.</div>
          </div>

          <div class="col-md-6">
            <div style="font-weight:700">Ваши дети</div>
            <div id="childrenList" class="mt-2">
              <div class="small text-muted">Загрузка...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- optionally quick actions -->
      <div class="card-soft">
        <h5>Контакты и заметки</h5>
        <p class="small" style="color:var(--muted)">Если нужно поменять остатки занятий — делаем это через админку тренера. Для экстренных вопросов звоните тренеру.</p>
      </div>
    </section>
  </main>

  <script>
    // === Настройки API ===
    // ЗАМЕНИТЕ gasUrl на ваш URL web app (deploy -> Web app -> URL /exec)
    const gasUrl = 'https://script.google.com/macros/s/AKfycbwdVdDFU-_w7VK_t-u0tTNbnm4YwhTspaBKUuq6JwUOlAqKiFLFPcQ_W1My1pTNKRl-7A/exec';

    // Telegram WebApp init (необязательно, но оставил)
    const webApp = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    try { webApp && webApp.ready(); } catch(e){ /* ignore */ }
    const user = webApp && webApp.initDataUnsafe ? webApp.initDataUnsafe.user : null;
    const telegramID = user ? user.id : 'test123';

    // === Навигация ===
    function setActiveNav(id) {
      document.querySelectorAll('.menu .nav-item button').forEach(b => b.classList.remove('active'));
      const btn = document.getElementById('nav-' + id);
      if (btn) btn.classList.add('active');
    }
    function showSection(name) {
      // sections: home, schedule, profile
      document.getElementById('homeSection').style.display = name === 'home' ? '' : 'none';
      document.getElementById('scheduleSection').style.display = name === 'schedule' ? '' : 'none';
      document.getElementById('profileSection').style.display = name === 'profile' ? '' : 'none';
      setActiveNav(name);
      if (name === 'profile') loadChildren();
    }

    // initial
    showSection('home');

    // === Работа с API: registerChild (form-urlencoded), loadChildren ===
    async function registerChild() {
      const nameInput = document.getElementById('childNameInput');
      const childName = (nameInput.value || '').trim();
      if (!childName) { alert('Введите имя ребёнка'); return; }

      try {
        const params = new URLSearchParams();
        params.append('action', 'addChild');
        params.append('telegramID', telegramID);
        params.append('childName', childName);

        const resp = await fetch(gasUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body: params.toString()
        });

        let result;
        try { result = await resp.json(); }
        catch (e) {
          const txt = await resp.text();
          console.error('Non-JSON response:', txt);
          alert('Ошибка сервера: ' + txt);
          return;
        }

        if (result.success) {
          nameInput.value = '';
          await loadChildren();
          showTinyToast('Ребёнок добавлен');
        } else {
          alert(result.message || 'Ошибка при добавлении');
        }
      } catch (err) {
        console.error(err);
        alert('Ошибка сети или неверный URL WebApp. Проверьте деплой и права доступа.');
      }
    }

    async function loadChildren() {
      const list = document.getElementById('childrenList');
      list.innerHTML = '<div class="small text-muted">Загрузка...</div>';
      try {
        const resp = await fetch(`${gasUrl}?action=getData&telegramID=${telegramID}`);
        const data = await resp.json();
        // ожидаем { success: true, children: [...] } (в зависимости от реализации)
        const children = (data.children && Array.isArray(data.children)) ? data.children : [];

        if (children.length === 0) {
          list.innerHTML = '<div class="small text-muted">Ребёнок(и) не зарегистрированы.</div>';
          return;
        }

        list.innerHTML = children.map(ch => {
          return `<div class="mb-2 child-card">
                    <div>
                      <div style="font-weight:700">${escapeHtml(ch.childName)}</div>
                      <div class="child-meta">Осталось занятий: <strong>${Number(ch.remaining)}</strong></div>
                    </div>
                    <div style="min-width:120px; text-align:right">
                      <button class="btn btn-sm btn-ghost" onclick="promptSetRemaining('${encodeURIComponent(ch.childName)}')">править</button>
                    </div>
                  </div>`;
        }).join('');
      } catch (err) {
        console.error(err);
        list.innerHTML = '<div class="small text-danger">Ошибка загрузки. Проверьте URL и права WebApp.</div>';
      }
    }

    function escapeHtml(text){
      if (text === undefined || text === null) return '';
      return String(text)
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'",'&#039;');
    }

    function promptSetRemaining(childNameEncoded){
      // Простой placeholder: тренер/админ должен менять количество в таблице; здесь можно подать подсказку.
      const name = decodeURIComponent(childNameEncoded);
      alert('Если нужно изменить количество занятий для ' + name + ', свяжитесь с тренером — изменения делаются через админку.');
    }

    // tiny toast
    function showTinyToast(msg){
      const el = document.createElement('div');
      el.style.position = 'fixed';
      el.style.right = '18px';
      el.style.bottom = '18px';
      el.style.padding = '10px 14px';
      el.style.background = 'linear-gradient(90deg,var(--accent),#6ec3ff)';
      el.style.color = '#fff';
      el.style.borderRadius = '10px';
      el.style.boxShadow = '0 10px 30px rgba(10,20,40,0.12)';
      el.style.fontWeight = 600;
      el.innerText = msg;
      document.body.appendChild(el);
      setTimeout(()=> el.style.opacity='0', 1700);
      setTimeout(()=> el.remove(), 2200);
    }

    // автозагрузка детей при старте, если профиль открыт
    // (не вызывать loadChildren на стартовой странице)
    // loadChildren();

  </script>
</body>
</html>
