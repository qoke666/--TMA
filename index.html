<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Детская школа карате</title>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
    body { margin: 0; font-family: 'Inter', sans-serif; background: #1F2937; color: #F3F4F6; }
    .menu { display: flex; justify-content: center; background: rgba(31, 41, 55, 0.9); backdrop-filter: blur(8px); padding: 6px 0; position: sticky; top: 0; z-index: 10; }
    .card { background: rgba(55, 65, 81, 0.3); backdrop-filter: blur(8px); border: 1px solid rgba(20, 184, 166, 0.3); border-radius: 12px; padding: 12px; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
    .calendar-day { padding: 8px; border-radius: 6px; text-align: center; font-size: 12px; font-weight: 500; transition: all 0.2s; }
    .calendar-day.clickable { cursor: pointer; }
    .calendar-day.clickable:hover { transform: scale(1.1); box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3); }
    .calendar-day.available { background: #34d399; color: #1F2937; }
    .calendar-day.limited { background: #f59e0b; color: #1F2937; }
    .calendar-day.full { background: #ef4444; color: #F3F4F6; }
    .calendar-day.disabled { background: rgba(243, 244, 246, 0.1); color: #6B7280; cursor: not-allowed; }
    .calendar-header { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 12px; text-align: center; font-size: 12px; font-weight: 600; color: #6B7280; }
    .modal { visibility: hidden; opacity: 0; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8); background: #2a374a; border: 1px solid #14B8A6; border-radius: 16px; padding: 20px; z-index: 1000; width: 90%; max-width: 400px; transition: all 0.3s; }
    .modal.active { visibility: visible; opacity: 1; transform: translate(-50%, -50%) scale(1); }
    .modal-overlay { visibility: hidden; opacity: 0; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 999; transition: all 0.3s; }
    .modal-overlay.active { visibility: visible; opacity: 1; }
    .modal h3 { margin: 0 0 10px; color: #14B8A6; font-size: 18px; text-align: center; }
    .modal .form-field { display: flex; flex-direction: column; gap: 4px; }
    .modal .apply-form { display: flex; flex-direction: column; gap: 10px; }
    .modal .apply-form label { font-size: 13px; color: #9CA3AF; }
    .modal .apply-form input, .modal .apply-form select, .modal .apply-form textarea { padding: 8px; border: 1px solid #4B5563; border-radius: 5px; background: #374151; color: #F3F4F6; width: 100%; }
    .modal .apply-form button { padding: 10px; background: #14B8A6; color: #F3F4F6; border: none; border-radius: 5px; font-weight: 600; cursor: pointer; transition: background 0.3s; }
    .modal .apply-form button:disabled { background: #4B5563; cursor: not-allowed; }
    .modal .close-button { margin-top: 10px; padding: 10px; background: #4B5563; }
    .spinner { border: 3px solid rgba(20, 184, 166, 0.2); border-top: 3px solid #14B8A6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 12px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="modal-overlay" id="modal-overlay"></div>
  <nav class="menu">
      <h1 class="text-lg font-bold text-white">Школа карате "Путь Воина"</h1>
  </nav>

  <main class="p-4">
    <section id="booking" class="section active">
      <div class="card" data-aos="fade-up">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-white" id="booking-calendar-title">Загрузка...</h3>
          <div class="flex space-x-2">
            <button class="prev-month p-2 rounded-full hover:bg-white/10"><i class="fas fa-chevron-left"></i></button>
            <button class="next-month p-2 rounded-full hover:bg-white/10"><i class="fas fa-chevron-right"></i></button>
          </div>
        </div>
        <div class="calendar-header"><div>Пн</div><div>Вт</div><div>Ср</div><div>Чт</div><div>Пт</div><div>Сб</div><div>Вс</div></div>
        <div class="calendar-grid" id="booking-calendar-grid"><div class="spinner"></div></div>
      </div>
    </section>
  </main>

  <div id="booking-modal" class="modal">
    <h3 id="modal-title">Запись на занятие</h3>
    <p id="modal-date" class="text-gray-400 mb-4 text-center"></p>
    <form id="booking-form" class="apply-form" autocomplete="off">
      <input type="hidden" id="selected-date" name="selectedDate">
      <div class="form-field"><label for="child-name">Имя ребенка</label><input type="text" id="child-name" name="childName" required></div>
      <div class="form-field new-user-field"><label for="child-age">Возраст</label><input type="number" id="child-age" name="childAge" required></div>
      <div class="form-field"><label for="group-select">Группа</label><select id="group-select" name="selectedGroup" required><option value="">-- Выберите группу --</option><option value="Младшая (4-6 лет)">Младшая (4-6 лет)</option><option value="Средняя (7-10 лет)">Средняя (7-10 лет)</option><option value="Старшая (11-14 лет)">Старшая (11-14 лет)</option></select><p id="group-time" class="text-xs text-teal-400 mt-1 h-4"></p></div>
      <div class="form-field new-user-field"><label for="contact-info">Ваш контакт (Телефон/Telegram)</label><input type="text" id="contact-info" name="contactInfo" required></div>
      <div class="form-field new-user-field"><label for="comments">Комментарии</label><textarea id="comments" name="comments" rows="2" placeholder="Аллергии, опыт и т.д."></textarea></div>
      <button type="submit" id="submit-booking">Записаться</button>
      <button type="button" class="close-button" id="close-modal-button">Отмена</button>
      <div id="modal-spinner" class="spinner" style="display: none;"></div>
    </form>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxdO84lmh_hYgA1wx4LRqrv55yNOirr33DaJjBL7OaKl7VoiAOI7WMbk-cXigzlJWKAXw/exec'; // <-- !!! ВАЖНО: ВСТАВЬТЕ СЮДА ВАШ URL !!!
      
      const tg = window.Telegram?.WebApp;
      if (tg) tg.expand();
      const userData = (tg?.initDataUnsafe?.user) ? { user_id: tg.initDataUnsafe.user.id, username: tg.initDataUnsafe.user.username } : {};

      let currentDate = new Date();
      let bookingsData = {};
      let returningUserData = null;
      
      const MAX_SPOTS = 10;
      const availableWeekdays = [2, 4, 6];
      const groupTimes = { "Младшая (4-6 лет)": "Время: 17:30 - 18:30", "Средняя (7-10 лет)": "Время: 18:30 - 19:30", "Старшая (11-14 лет)": "Время: 19:30 - 20:30" };

      AOS.init({ duration: 600, once: true, offset: 20 });

      const modal = document.getElementById('booking-modal');
      const modalOverlay = document.getElementById('modal-overlay');
      const bookingForm = document.getElementById('booking-form');
      const modalSpinner = document.getElementById('modal-spinner');
      const submitButton = document.getElementById('submit-booking');
      const calendarGrid = document.getElementById('booking-calendar-grid');
      const calendarTitle = document.getElementById('booking-calendar-title');

      async function postEvent(eventName, additionalData = {}) {
        const payload = { event: eventName, ...userData, timestamp: new Date().toISOString(), additional: additionalData };
        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          mode: 'cors',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);
        return result;
      }

      async function fetchInitialData() {
        try {
          const url = new URL(WEB_APP_URL);
          if (userData.user_id) url.searchParams.append('user_id', userData.user_id);
          
          const response = await fetch(url);
          if (!response.ok) throw new Error(`Код ответа: ${response.status}`);
          const result = await response.json();

          if (result.status === 'success') {
            bookingsData = result.bookings;
            returningUserData = result.user;
            return true;
          } else {
            throw new Error(result.message);
          }
        } catch (error) {
          console.error('Не удалось загрузить данные:', error);
          calendarTitle.textContent = 'Ошибка загрузки';
          calendarGrid.innerHTML = `<p class="text-red-400 text-center col-span-7">Не удалось загрузить расписание. Проверьте правильность URL в коде и убедитесь, что создано новое развертывание в Apps Script.</p>`;
          return false;
        }
      }

      function updateCalendar() {
        calendarGrid.innerHTML = '';
        calendarTitle.textContent = `${currentDate.toLocaleString('ru', { month: 'long' })} ${currentDate.getFullYear()}`;
        
        const month = currentDate.getMonth();
        const year = currentDate.getFullYear();
        const firstDayOfMonth = new Date(year, month, 1);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const startDayOfWeek = (firstDayOfMonth.getDay() + 6) % 7;

        for (let i = 0; i < startDayOfWeek; i++) calendarGrid.insertAdjacentHTML('beforeend', '<div></div>');

        for (let day = 1; day <= daysInMonth; day++) {
          const dayDate = new Date(year, month, day);
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          const dayElement = document.createElement('div');
          dayElement.textContent = day;
          dayElement.classList.add('calendar-day');
          
          const dateString = dayDate.toLocaleDateString('ru');
          const spotsTaken = bookingsData[dateString] || 0;

          if (dayDate < today || !availableWeekdays.includes(dayDate.getDay())) {
            dayElement.classList.add('disabled');
          } else {
            dayElement.classList.add('clickable');
            if (spotsTaken >= MAX_SPOTS) dayElement.classList.add('full');
            else if (spotsTaken > 0) dayElement.classList.add('limited');
            else dayElement.classList.add('available');
            dayElement.addEventListener('click', () => openModal(dayDate));
          }
          calendarGrid.appendChild(dayElement);
        }
      }
      
      function openModal(date) {
        bookingForm.reset();
        document.getElementById('group-time').textContent = '';
        document.getElementById('modal-date').textContent = `на ${date.toLocaleDateString('ru')}`;
        document.getElementById('selected-date').value = date.toLocaleDateString('ru');

        const newUserFields = document.querySelectorAll('.new-user-field');
        if (returningUserData) {
          document.getElementById('modal-title').textContent = 'С возвращением!';
          document.getElementById('child-name').value = returningUserData.childName;
          newUserFields.forEach(field => field.style.display = 'none');
        } else {
          document.getElementById('modal-title').textContent = 'Новая запись';
          newUserFields.forEach(field => field.style.display = 'flex');
        }
        
        modal.classList.add('active');
        modalOverlay.classList.add('active');
      }

      function closeModal() {
        modal.classList.remove('active');
        modalOverlay.classList.remove('active');
      }
      
      document.querySelector('.prev-month').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        updateCalendar();
      });
      document.querySelector('.next-month').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        updateCalendar();
      });

      document.getElementById('close-modal-button').addEventListener('click', closeModal);
      modalOverlay.addEventListener('click', closeModal);
      
      document.getElementById('group-select').addEventListener('change', (e) => {
        const time = groupTimes[e.target.value] || '';
        document.getElementById('group-time').textContent = time;
      });

      bookingForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        modalSpinner.style.display = 'block';
        submitButton.disabled = true;

        const formData = new FormData(bookingForm);
        let data = Object.fromEntries(formData.entries());

        if (returningUserData) {
          data.childAge = returningUserData.childAge;
          data.contactInfo = returningUserData.contactInfo;
        }

        try {
          await postEvent('booking_request', data);
          tg?.showPopup({ title: 'Успешно!', message: 'Вы записаны!' });
          closeModal();
          initializeApp();
        } catch (error) {
          tg?.showPopup({ title: 'Ошибка', message: error.message });
        } finally {
          modalSpinner.style.display = 'none';
          submitButton.disabled = false;
        }
      });

      async function initializeApp() {
        const success = await fetchInitialData();
        if (success) {
            updateCalendar();
        }
      }

      initializeApp();
    });
  </script>
</body>
</html>
