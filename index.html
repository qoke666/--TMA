<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TMA — Тёмный Бал (демо)</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  :root{
    --bg:#070707; --fg:#efe6db; --muted:#bfb8ad;
    --accent:#b23b3b; --gold:#b88b2f;
    --transition-time:700ms;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{background:var(--bg);color:var(--fg);overflow-x:hidden;transition:background var(--transition-time) ease,color var(--transition-time) ease}
  /* HEADER */
  .menu-top{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;position:relative;z-index:12}
  .logo{width:120px;height:auto;transition:transform .6s ease,opacity .6s ease}
  .logo.hidden{transform:translateY(-18px) scale(.8);opacity:0;pointer-events:none}
  .social-links{display:flex;gap:10px;align-items:center;color:var(--muted)}
  .social-link{color:var(--muted);font-size:18px}
  /* CAROUSEL */
  .carousel{width:360px;height:150px;margin:8px auto;border-radius:8px;overflow:hidden;transition:transform .6s ease,opacity .6s ease}
  .carousel.hidden{transform:translateY(-18px) scale(.98);opacity:0;pointer-events:none}
  .carousel img{width:100%;height:100%;object-fit:cover;display:block}

  /* NAV */
  .menu{display:flex;justify-content:center;position:sticky;top:0;background:transparent;padding:10px 8px;z-index:11}
  .menu ul{display:flex;gap:10px;padding:0;margin:0}
  .menu-item{padding:8px 14px;border-radius:8px;color:var(--muted);cursor:pointer;font-weight:600}
  .menu-item:hover{background:rgba(255,255,255,0.03);color:var(--fg)}
  .menu-item.active{background:var(--accent);color:#fff}

  /* SECTIONS */
  .section{padding:18px;min-height:200px;transition:opacity .4s ease}
  .section.hidden{display:none}
  .section-title{font-family:Cinzel,serif;color:var(--gold);font-size:28px;margin:8px 0}

  /* EVENTS HERO */
  .event-hero{display:flex;justify-content:space-between;align-items:center;padding:22px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.12));border:1px solid rgba(255,255,255,0.03)}
  .event-left{flex:1;min-width:260px}
  .event-title{font-family:Cinzel,serif;font-size:34px;margin:0;color:var(--gold);text-shadow:0 2px 8px rgba(0,0,0,.6)}
  .event-sub{color:var(--muted);margin:8px 0 12px}
  .event-cta{display:flex;gap:10px;flex-wrap:wrap}
  .btn-primary{background:linear-gradient(180deg,var(--accent),#600000);color:#fff;padding:10px 16px;border-radius:10px;border:none;cursor:pointer;font-weight:700;box-shadow:0 10px 30px rgba(178,59,59,0.18)}
  .btn-ghost{padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--muted);cursor:pointer}

  /* Canvas overlay for bats */
  #batCanvas{position:fixed;inset:0;z-index:50;pointer-events:none;opacity:0;transition:opacity .4s ease}
  #curtain{position:fixed;inset:0;z-index:48;background:linear-gradient(180deg,rgba(8,4,4,0.92),rgba(6,2,2,0.88));transform:translateY(-100%);transition:transform .9s cubic-bezier(.22,.9,.35,1);pointer-events:none}
  #curtain.open{transform:translateY(0%)}

  /* velvet overlay that softens during transition */
  #velvet{position:fixed;inset:0;z-index:49;background:radial-gradient(circle at 20% 10%, rgba(255,255,255,0.02), rgba(0,0,0,0.85));opacity:0;transition:opacity .5s ease}

  /* Modal (improved) */
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(.85);z-index:60;background:linear-gradient(180deg,#110909 0%,#0a0606 100%);border-radius:16px;padding:18px;min-width:320px;max-width:680px;color:var(--fg);box-shadow:0 30px 80px rgba(0,0,0,.7);opacity:0;transition:opacity .35s ease,transform .35s cubic-bezier(.2,.9,.25,1);border:2px solid rgba(184,139,47,.12);font-family:Inter}
  .modal.show{opacity:1;transform:translate(-50%,-50%) scale(1)}
  .modal .header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  .modal .title{font-family:Cinzel,serif;color:var(--gold);font-size:20px;margin:0}
  .modal .close{background:transparent;border:1px solid rgba(255,255,255,0.05);padding:6px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
  .modal form{display:grid;gap:8px}
  .modal label{font-size:13px;color:var(--muted)}
  .modal input, .modal select{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.15);color:var(--fg)}
  .modal .submit{background:linear-gradient(180deg,var(--gold),#9a751e);padding:10px;border-radius:10px;border:none;color:#140b00;font-weight:700;cursor:pointer}

  /* Hidden helpers */
  .fade-out{transition:opacity .5s ease,transform .6s ease}
  .invisible{opacity:0;transform:translateY(-8px)}
  /* small responsiveness */
  @media (max-width:700px){
    .event-hero{flex-direction:column;align-items:flex-start}
    .event-right{text-align:left;margin-top:12px}
    .logo{width:96px}
    .carousel{width:100%;height:120px}
  }
</style>
</head>
<body>
  <!-- Header: логотип и соцсети -->
  <div class="menu-top">
    <img class="logo" id="siteLogo" src="https://i.postimg.cc/90gRT1n1/Frame-2.png" alt="TMA Logo">
    <div>
      <div class="carousel" id="carousel">
        <img src="https://i.postimg.cc/bJqQWjv5/photo-2025-03-18-15-18-14.jpg" alt="banner">
      </div>
    </div>
    <div class="social-links">
      <a class="social-link" href="#"><i class="fab fa-telegram-plane"></i></a>
      <a class="social-link" href="#"><i class="fab fa-instagram"></i></a>
    </div>
  </div>

  <!-- NAV -->
  <nav class="menu" aria-label="Главное меню">
    <ul>
      <li class="menu-item active" data-section="home">Главная</li>
      <li class="menu-item" data-section="articles">Статьи</li>
      <li class="menu-item" data-section="cases">Кейсы</li>
      <li class="menu-item" data-section="vacancies">Вакансии</li>
      <li class="menu-item" data-section="events" id="eventsNav">Мероприятия</li>
    </ul>
  </nav>

  <!-- sections -->
  <section id="home" class="section">
    <h2 class="section-title">АКТУАЛЬНОЕ</h2>
    <p style="color:var(--muted)">Здесь ваш основной контент — оставил место для твоего старого текста.</p>
  </section>

  <section id="articles" class="section hidden"><h2 class="section-title">СТАТЬИ</h2></section>
  <section id="cases" class="section hidden"><h2 class="section-title">КЕЙСЫ</h2></section>
  <section id="vacancies" class="section hidden"><h2 class="section-title">ВАКАНСИИ</h2></section>

  <section id="events" class="section hidden" aria-labelledby="eventsTitle">
    <h2 id="eventsTitle" class="section-title">МЕРОПРИЯТИЯ</h2>

    <div class="event-hero" id="eventHero">
      <div class="event-left">
        <h3 class="event-title">Тёмный Бал — Русская Готика</h3>
        <p class="event-sub">Закрытое событие: перформансы, бар, нетворкинг в атмосфере старых усадеб и бархата.</p>
        <div class="event-cta">
          <button class="btn-primary" id="openRegister">Узнать и зарегистрироваться</button>
          <button class="btn-ghost" id="previewAnim">Превью анимации</button>
        </div>
      </div>
      <div class="event-right" style="text-align:right;min-width:200px">
        <div style="color:var(--muted)">Дата: 13 дек. 2025</div>
        <div style="color:var(--muted)">Место: Москва, адрес — по приглашениям</div>
        <div style="color:var(--muted)">Dress-code: Русская готика</div>
      </div>
    </div>
  </section>

  <!-- Canvas для роев летучих мышей -->
  <canvas id="batCanvas" aria-hidden="true"></canvas>

  <!-- curtain & velvet for dramatic reveal -->
  <div id="curtain" aria-hidden="true"></div>
  <div id="velvet" aria-hidden="true"></div>

  <!-- Modal template -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true" style="display:none">
    <div class="header">
      <div class="title">Регистрация — Тёмный Бал</div>
      <button class="close" id="modalClose">Закрыть</button>
    </div>
    <form id="regForm">
      <label>Имя</label>
      <input name="name" required placeholder="Иван Иванов">
      <label>Telegram (@username)</label>
      <input name="telegram" placeholder="@username" pattern="@[A-Za-z0-9_]{5,}" required>
      <label>Email (опционально)</label>
      <input name="email" type="email" placeholder="mail@example.com">
      <label>Тип билета</label>
      <select name="tickets" required>
        <option value="">Выберите</option>
        <option value="1">1 — стандарт</option>
        <option value="2">2 — пара</option>
        <option value="vip">VIP</option>
      </select>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="submit" type="submit">Отправить</button>
        <button type="button" class="close" id="modalCancel">Отмена</button>
      </div>
    </form>
  </div>

<script>
/* =========================
   Настройки (правь здесь)
   ========================= */
const SHEET_ENDPOINT = 'https://script.google.com/macros/s/AKfycbxRK9cnnKCBM4AypS_cPFlYWkowUfBRiwFHbHYBcWNREHuy25nx1JvUVatPtVk1BzU_Mw/exec';
const BATS_COUNT = 140;     // плотность ро́я — повысить/понизить
const BATS_SCALE = 0.9;     // размер летучих мышей
const TRANSITION_MS = 1600; // время, через которое завершится переход (ms)

/* =========================
   Утилиты
   ========================= */
function sendToSheet(data){
  fetch(SHEET_ENDPOINT, {method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)})
    .catch(e => console.log('sheet err', e));
}
function uuidv4(){ return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0;return (c=='x'?r:(r&0x3|0x8)).toString(16)})}

/* =========================
   Canvas bats system
   ========================= */
const canvas = document.getElementById('batCanvas');
const ctx = canvas.getContext('2d');
let W = canvas.width = innerWidth;
let H = canvas.height = innerHeight;
window.addEventListener('resize', ()=>{ W = canvas.width = innerWidth; H = canvas.height = innerHeight; });

/* Prepare bat image from SVG for crisp rendering */
const batSvg = `
<svg xmlns='http://www.w3.org/2000/svg' width='160' height='96' viewBox='0 0 160 96'>
  <g fill="none" fill-rule="evenodd">
    <path d="M6 55c14-12 28-24 44-22 10 1 19 7 26 12 7-5 16-11 26-12 16-2 30 10 44 22-12-12-28-20-44-16-11 3-19 9-24 12-5-3-13-9-24-12-16-4-32 4-44 16z" fill="#0b0b0b"/>
    <ellipse cx="80" cy="60" rx="24" ry="12" fill="#0b0b0b" />
  </g>
</svg>`;
const batImg = new Image();
batImg.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(batSvg);

/* Particle structure */
class Bat {
  constructor(){
    this.reset(true);
  }
  reset(init=false){
    // spawn around top region or random (for initial fill)
    this.x = Math.random() * W;
    this.y = init ? Math.random()*H : -40 - Math.random()*H*0.6;
    this.vx = (Math.random()*2 - 1) * (1.2 + Math.random()*1.6);
    this.vy = 0.6 + Math.random()*1.6;
    this.amp = 12 + Math.random()*36;           // amplitude of sine wave
    this.freq = 0.01 + Math.random()*0.03;
    this.angle = Math.random()*Math.PI*2;
    this.size = (12 + Math.random()*24) * BATS_SCALE;
    this.rot = (Math.random()*40 - 20) * Math.PI/180;
    this.opacity = 0.08 + Math.random()*0.9;
    this.depth = Math.random(); // used to vary speed and size for parallax
  }
  update(dt){
    this.angle += this.freq * dt;
    this.x += this.vx * (0.8 + this.depth*1.6);
    this.y += this.vy * (0.9 + this.depth*1.6);
    // sine vertical / horizontal offsets
    this.ox = Math.sin(this.angle * 1.5) * this.amp;
    // rotation wiggle
    this.rot += Math.sin(this.angle*2) * 0.02;
    // respawn if out of bounds
    if(this.y > H + 100 || this.x < -200 || this.x > W + 200){
      this.reset(false);
      this.y = -20 - Math.random()*120;
      this.x = Math.random()*W;
    }
  }
  draw(ctx){
    ctx.save();
    ctx.globalAlpha = Math.min(1, this.opacity);
    // create slight parallax scaling
    const s = (this.depth*0.6 + 0.6) * (this.size/48);
    ctx.translate(this.x + this.ox, this.y);
    ctx.rotate(this.rot);
    // shadow
    ctx.shadowColor = 'rgba(0,0,0,0.6)';
    ctx.shadowBlur = 8 * (0.5 + this.depth);
    // draw image centered
    const w = batImg.width * s;
    const h = batImg.height * s;
    ctx.drawImage(batImg, -w/2, -h/2, w, h);
    ctx.restore();
  }
}

let bats = [];
function spawnBats(count){
  bats = [];
  for(let i=0;i<count;i++) bats.push(new Bat());
}

/* Animation loop */
let last = performance.now();
let animRunning = false;
function loop(now){
  const dt = now - last;
  last = now;
  ctx.clearRect(0,0,W,H);
  // draw subtle background glow when active
  ctx.save();
  ctx.globalCompositeOperation = 'lighter';
  for(const b of bats){
    b.update(dt);
    b.draw(ctx);
  }
  ctx.restore();
  if(animRunning) requestAnimationFrame(loop);
}

/* Controls to show/hide bats overlay */
const batCanvasEl = document.getElementById('batCanvas');
function showBats(dense = true){
  batCanvasEl.style.opacity = 1;
  spawnBats(dense ? BATS_COUNT : Math.floor(BATS_COUNT/3));
  animRunning = true;
  last = performance.now();
  requestAnimationFrame(loop);
}
function hideBats(){
  // fade out and stop
  batCanvasEl.style.opacity = 0;
  setTimeout(()=> animRunning = false, 500);
}

/* =========================
   Page transition logic
   ========================= */
const eventsNav = document.getElementById('eventsNav');
const menuItems = document.querySelectorAll('.menu-item');
const sections = document.querySelectorAll('.section');
const logo = document.getElementById('siteLogo');
const carousel = document.getElementById('carousel');
const curtain = document.getElementById('curtain');
const velvet = document.getElementById('velvet');
const previewBtn = document.getElementById('previewAnim');

function setActiveSection(id){
  sections.forEach(s => s.id === id ? s.classList.remove('hidden') : s.classList.add('hidden'));
  menuItems.forEach(mi => mi.classList.toggle('active', mi.dataset.section === id));
  window.scrollTo({top:0,behavior:'smooth'});
}

/* When events clicked: dramatic transition */
eventsNav.addEventListener('click', async ()=>{
  // 1. start curtain drop (dramatic)
  curtain.classList.add('open');
  // 2. start velvet (soften)
  velvet.style.opacity = 1;
  // 3. show bats and hide logo + carousel with small delay to let user absorb
  setTimeout(()=>{
    // hide header elements elegantly
    logo.classList.add('hidden');
    carousel.classList.add('hidden');
    // show dense bats
    showBats(true);
  }, 300);
  // 4. after a while (transition finish) switch palette and show events section
  setTimeout(()=>{
    document.body.style.background = '#080204';
    document.body.style.color = '#efe6db';
    curtain.classList.remove('open'); // curtain lifts back up after reveal
    // reveal events content
    setActiveSection('events');
    // slight delay then hide bats gradually to keep mood but allow interaction
    setTimeout(()=> hideBats(), 900);
  }, TRANSITION_MS);
});

/* preview button - short preview */
previewBtn.addEventListener('click', ()=>{
  curtain.classList.add('open');
  velvet.style.opacity = 1;
  setTimeout(()=> showBats(false), 220);
  setTimeout(()=> { curtain.classList.remove('open'); hideBats(); velvet.style.opacity = 0; }, 1600);
});

/* Clicking other menu items should revert look */
menuItems.forEach(mi => {
  mi.addEventListener('click', ()=>{
    if(mi.dataset.section !== 'events'){
      // revert visuals
      logo.classList.remove('hidden');
      carousel.classList.remove('hidden');
      velvet.style.opacity = 0;
      hideBats();
      // gentle revert of palette
      document.body.style.background = '';
      document.body.style.color = '';
      setActiveSection(mi.dataset.section);
    }
  });
});

/* =========================
   Modal & registration
   ========================= */
const modal = document.getElementById('modal');
const openRegister = document.getElementById('openRegister');
const modalClose = document.getElementById('modalClose');
const modalCancel = document.getElementById('modalCancel');
const regForm = document.getElementById('regForm');

function openModal(){
  modal.style.display = 'block';
  setTimeout(()=> { modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); }, 20);
  // make sure bats stay but clickable elements are accessible
}
function closeModal(){
  modal.classList.remove('show');
  modal.setAttribute('aria-hidden','true');
  setTimeout(()=> { modal.style.display='none'; }, 350);
}

openRegister.addEventListener('click', ()=> openModal());
modalClose.addEventListener('click', ()=> closeModal());
modalCancel.addEventListener('click', ()=> closeModal());

regForm.addEventListener('submit', e => {
  e.preventDefault();
  const fd = new FormData(regForm);
  const name = fd.get('name') || '';
  const telegram = fd.get('telegram') || '';
  const tickets = fd.get('tickets') || '';
  if(!telegram || !telegram.startsWith('@')) { alert('Укажите корректный Telegram (@username)'); return; }
  const payload = { event: 'registration', id: uuidv4(), name, telegram, tickets, ts: new Date().toISOString(), ua: navigator.userAgent };
  sendToSheet(payload);
  // success UI
  regForm.innerHTML = `<div style="text-align:center;padding:18px">
    <h3 style="color:var(--gold);margin:8px 0">Спасибо — заявка принята</h3>
    <p style="color:var(--muted)">Мы свяжемся в Telegram для подтверждения участия.</p>
    <div style="margin-top:12px"><button class="close" id="closeAfter">Закрыть</button></div>
  </div>`;
  document.getElementById('closeAfter').addEventListener('click', closeModal);
});

/* Initialize default view */
setActiveSection('home');

/* Accessibility: keyboard nav for menu */
menuItems.forEach(mi=> mi.tabIndex = 0);

/* Preload bat image to avoid pop-in */
batImg.onload = ()=>{ /* ready */ };

/* End of script */
</script>
</body>
</html>
