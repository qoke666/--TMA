<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Расписание Карате</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background-color: #f8f9fa; padding: 20px; }
        .container { max-width: 600px; margin: auto; }
        .schedule { margin-top: 20px; }
        .hidden { display: none; }
        #errorMessage { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Расписание занятий по карате</h1>
        
        <!-- Расписание -->
        <div class="schedule card p-3 mb-4">
            <h5>Расписание:</h5>
            <ul class="list-group">
                <li class="list-group-item">Понедельник: 18:00 - 19:30</li>
                <li class="list-group-item">Среда: 18:00 - 19:30</li>
                <li class="list-group-item">Пятница: 17:00 - 18:30</li>
            </ul>
        </div>
        
        <!-- Регистрация -->
        <div id="registerSection" class="card p-3 mb-4">
            <h5>Зарегистрировать ребенка</h5>
            <input type="text" id="childName" class="form-control mb-2" placeholder="Имя ребенка">
            <button onclick="registerChild()" class="btn btn-primary">Зарегистрировать</button>
            <p class="small text-muted mt-2">Можно добавить несколько детей.</p>
        </div>
        
        <!-- Дети -->
        <div id="childrenSection" class="card p-3">
            <h5>Ваши дети</h5>
            <div id="childrenList">
                <p id="loadingInfo" class="text-center">Загрузка...</p>
            </div>
            <div id="errorMessage" class="hidden"></div>
            
            <div id="selectChildDiv" class="mt-3 hidden">
                <label for="childSelect" class="form-label">Выберите ребенка:</label>
                <select id="childSelect" class="form-select"></select>
                <button onclick="selectChild()" class="btn btn-primary mt-2">Показать данные</button>
            </div>
            
            <div id="selectedInfo" class="mt-3 hidden">
                <h6 id="selectedName"></h6>
                <p id="selectedRemaining"></p>
                <button onclick="loadData()" class="btn btn-secondary mt-2">Обновить данные</button>
            </div>
        </div>
    </div>

    <script>
        const webApp = window.Telegram.WebApp;
        webApp.ready();
        const user = webApp.initDataUnsafe.user;
        const telegramID = user ? user.id : 'test123'; // Для теста
        const gasUrl = 'https://script.google.com/macros/s/AKfycbwdVdDFU-_w7VK_t-u0tTNbnm4YwhTspaBKUuq6JwUOlAqKiFLFPcQ_W1My1pTNKRl-7A/exec'; // Замени на свой URL GAS

        console.log('Debug: TelegramID =', telegramID); // Отладка ID
        console.log('Debug: GAS URL =', gasUrl); // Отладка URL

        let allChildren = [];
        let selectedChildIndex = -1;

        async function registerChild() {
            const childName = document.getElementById('childName').value.trim();
            if (!childName) {
                showError('Введите имя ребенка!');
                return;
            }
            
            console.log('Debug: Registering child:', childName, 'with ID:', telegramID); // Отладка
            
            try {
                const response = await fetch(gasUrl, {
                    method: 'POST',
                    mode: 'cors', // Явно CORS
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegramID, childName })
                });
                
                console.log('Debug: POST Response status:', response.status); // Отладка статус
                console.log('Debug: POST Response headers:', response.headers); // Отладка headers
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Debug: POST Result:', result); // Отладка ответа
                
                if (result.success) {
                    alert('Ребенок зарегистрирован!');
                    document.getElementById('childName').value = '';
                    loadData();
                } else {
                    showError(result.message || 'Ошибка регистрации');
                }
            } catch (error) {
                console.error('Debug: POST Error:', error); // Отладка ошибки
                showError('Ошибка регистрации: ' + error.message);
            }
        }

        async function loadData() {
            const loadingInfo = document.getElementById('loadingInfo');
            loadingInfo.innerText = 'Загрузка данных...';
            clearError();
            
            console.log('Debug: Loading data for ID:', telegramID); // Отладка
            
            try {
                const response = await fetch(`${gasUrl}?action=getData&telegramID=${telegramID}`, {
                    method: 'GET',
                    mode: 'cors' // Явно CORS
                });
                
                console.log('Debug: GET Response status:', response.status); // Отладка статус
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Debug: GET Data:', data); // Отладка ответа
                
                if (data.error) {
                    document.getElementById('childrenList').innerText = 'Нет зарегистрированных детей.';
                    document.getElementById('selectChildDiv').classList.add('hidden');
                    document.getElementById('selectedInfo').classList.add('hidden');
                    document.getElementById('registerSection').classList.remove('hidden');
                    allChildren = [];
                    return;
                }
                
                allChildren = data.children;
                showChildrenList();
            } catch (error) {
                console.error('Debug: GET Error:', error); // Отладка ошибки
                showError('Ошибка загрузки: ' + error.message);
            }
        }

        function showChildrenList() {
            const listDiv = document.getElementById('childrenList');
            const selectDiv = document.getElementById('selectChildDiv');
            const select = document.getElementById('childSelect');
            const selectedInfo = document.getElementById('selectedInfo');
            
            if (allChildren.length === 0) {
                listDiv.innerText = 'Нет детей.';
                selectDiv.classList.add('hidden');
                selectedInfo.classList.add('hidden');
                return;
            }
            
            let listHTML = '<ul class="list-unstyled">';
            allChildren.forEach(child => {
                listHTML += `<li>${child.name}: ${child.remaining} занятий</li>`;
            });
            listHTML += '</ul>';
            listDiv.innerHTML = listHTML;
            
            select.innerHTML = '';
            allChildren.forEach((child, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${child.name} (${child.remaining} занятий)`;
                select.appendChild(option);
            });
            
            selectDiv.classList.remove('hidden');
            document.getElementById('registerSection').classList.remove('hidden');
            if (allChildren.length === 1) {
                selectedChildIndex = 0;
                showSelectedChild();
                selectDiv.classList.add('hidden');
            } else {
                selectedInfo.classList.add('hidden');
            }
        }

        function selectChild() {
            selectedChildIndex = parseInt(document.getElementById('childSelect').value);
            showSelectedChild();
        }

        function showSelectedChild() {
            if (selectedChildIndex < 0 || !allChildren[selectedChildIndex]) return;
            
            const child = allChildren[selectedChildIndex];
            document.getElementById('selectedName').innerText = `Ребенок: ${child.name}`;
            document.getElementById('selectedRemaining').innerText = `${child.remaining} занятий осталось`;
            document.getElementById('selectedInfo').classList.remove('hidden');
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerText = message;
            errorDiv.classList.remove('hidden');
        }

        function clearError() {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerText = '';
            errorDiv.classList.add('hidden');
        }

        loadData();
    </script>
</body>
</html>
